<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Pagos - Reporte</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #eef2f3; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { color: #1a73e8; text-align: center; margin-bottom: 20px; }
        label { display: block; font-size: 13px; font-weight: bold; color: #555; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { width: 100%; padding: 14px; background: #1a73e8; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
        #info { background: #fff3e0; padding: 15px; border-radius: 8px; border: 1px solid #ffe0b2; margin-bottom: 15px; display: none; color: #e65100; }
    </style>
</head>
<body>
<div class="card">
    <h2>Portal de Pagos</h2>
    <label>Nombre y Apellido del Estudiante</label>
    <input type="text" id="nomBus" placeholder="Escriba el nombre tal cual se registró">
    <button id="btnBus">CONSULTAR DEUDA</button>
    
    <div id="info"></div>

    <div id="formRep" style="display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
        <label>Grado</label>
        <input type="text" id="grado" readonly style="background: #f1f3f4;">
        <label>Representante</label>
        <input type="text" id="rep" readonly style="background: #f1f3f4;">
        <label>Referencia Bancaria</label>
        <input type="text" id="ref" placeholder="Número de transferencia">
        <label>Monto a Reportar ($)</label>
        <input type="number" id="pago" placeholder="Monto pagado">
        <button id="btnEnv" style="background: #1e8e3e;">ENVIAR REPORTE</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    const firebaseConfig = { apiKey: "AIzaSyC_m1k2Vlu5QTokgjNZ6czlI2XH1YTC3U8", authDomain: "reportedepagos-d8485.firebaseapp.com", projectId: "reportedepagos-d8485", storageBucket: "reportedepagos-d8485.appspot.com", messagingSenderId: "335664812002", appId: "1:335664812002:web:609ecb3008145281af3bb8" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    let idD = null; let monD = 0;

    document.getElementById("btnBus").addEventListener("click", async () => {
        // Ahora buscamos por nombreEst en lugar de cédula
        const q = query(collection(db, "deudas"), where("nombreEst", "==", nomBus.value.trim()));
        const s = await getDocs(q);
        if (!s.empty) {
            s.forEach(d => {
                const i = d.data(); idD = d.id; monD = parseFloat(i.montoDeuda);
                document.getElementById("info").style.display = "block";
                document.getElementById("info").innerHTML = `<b>Deuda Pendiente: $${i.montoDeuda}</b><br><small>Representante: ${i.nombreRep}</small>`;
                document.getElementById("grado").value = i.gradoEst;
                document.getElementById("rep").value = i.nombreRep;
                document.getElementById("formRep").style.display = "block";
            });
        } else { alert("No se encontró deuda para este estudiante. Verifique que el nombre esté bien escrito."); }
    });

    document.getElementById("btnEnv").addEventListener("click", async () => {
        const pg = parseFloat(pago.value);
        const referencia = document.getElementById("ref").value;
        
        if(!referencia || isNaN(pg) || pg <= 0) {
            alert("Error: Ingrese Referencia y Monto.");
            return;
        }

        await addDoc(collection(db, "pagos_reportados"), { 
            nombreEst: nomBus.value.trim(), 
            nombreRep: rep.value, 
            gradoEst: grado.value, 
            referencia: referencia, 
            monto: pg, 
            fecha: new Date() 
        });

        if (pg >= monD) { 
            await deleteDoc(doc(db, "deudas", idD)); 
            alert("¡Reporte enviado! Deuda saldada."); 
        } else { 
            const n = monD - pg; 
            await updateDoc(doc(db, "deudas", idD), { montoDeuda: n.toFixed(2).toString() }); 
            alert("Abono registrado. Nueva deuda: $" + n.toFixed(2)); 
        }
        location.reload();
    });
</script>
</body>
</html>
