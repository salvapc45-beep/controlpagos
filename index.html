<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA SDJ - CONTROL V16</title>
    <style>
        :root {
            --primary: #1e3a8a; --bg: #f8fafc; --text: #0f172a;
            --green: #22c55e; --yellow: #eab308; --red: #ef4444;
            --whatsapp: #25D366; --gmail: #EA4335;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }

        header { background: var(--primary); color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        /* NAV */
        nav { display: flex; background: white; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid #e2e8f0; overflow-x: auto; }
        .nav-btn { flex: 1; min-width: 100px; padding: 15px 5px; text-align: center; cursor: pointer; font-weight: bold; font-size: 11px; color: #64748b; text-transform: uppercase; border-bottom: 4px solid transparent; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #f1f5f9; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .modulo { display: none; }
        .modulo.active { display: block; animation: fadeIn 0.4s; }

        /* CARDS & FORMS */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-top: 8px; font-size: 14px; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        
        /* ALERTAS & PENDIENTES */
        .btn-alert-all { background: #4f46e5; color: white; width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
        .btn-critico { background: #dc2626; color: white; width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(220, 38, 38, 0.3); }

        .grado-header { background: #1e293b; color: white; padding: 10px 15px; border-radius: 6px; font-weight: bold; text-transform: uppercase; font-size: 13px; margin: 25px 0 10px 0; letter-spacing: 0.5px; }

        .student-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 8px; position: relative; }
        
        /* BORDES DE ALERTA */
        .alert-previa { border-left: 6px solid var(--green); }
        .alert-normal { border-left: 6px solid var(--yellow); }
        .alert-urgente { border-left: 6px solid var(--red); }

        /* BADGES (ETIQUETAS) */
        .badge { font-size: 9px; padding: 3px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; display: inline-block; margin-bottom: 4px; }
        .bg-previa { background: #dcfce7; color: #15803d; }
        .bg-normal { background: #fef9c3; color: #a16207; }
        .bg-urgente { background: #fee2e2; color: #b91c1c; }

        .info b { display: block; font-size: 15px; color: var(--primary); }
        .info small { color: #64748b; font-size: 12px; display: block; }
        .tag-mes { display: inline-block; background: #f1f5f9; border: 1px solid #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin: 4px 2px 0 0; color: #475569; }

        /* ARCHIVOS */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 15px; }
        .folder { background: white; border: 1px solid #e2e8f0; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .folder:hover { background: #f8fafc; border-color: var(--primary); }
        .icon { font-size: 30px; display: block; margin-bottom: 5px; }

        /* TABLA REPORTES */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; font-size: 12px; }
        th { background: #f1f5f9; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        /* FILA CLICKABLE */
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background: #f8fafc; }
        
        .btn-check { background: var(--green); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-right: 5px; font-weight: bold; }
        .btn-reject { background: var(--red); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .btn-ws { border:none; background:transparent; font-size:22px; cursor:pointer; color: var(--whatsapp); margin-right: 10px; }
        .btn-email { border:none; background:transparent; font-size:22px; cursor:pointer; color: var(--gmail); margin-right: 10px; }
        .btn-print { background: #64748b; color: white; border:none; padding: 8px 15px; border-radius: 5px; cursor: pointer; float: right; font-size: 12px;}

        /* FICHA ESTUDIANTE */
        .ficha-container { margin-top: 20px; }
        .ficha-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-edit { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-delete { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* PORTAL PADRES */
        .parent-portal { background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .parent-results { margin-top: 20px; }
        .family-total { background: #0f172a; color: white; padding: 15px; border-radius: 8px; text-align: center; margin-top: 15px; font-weight: bold; font-size: 18px; }

        /* MODAL DETALLES PAGO */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 2000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
        }
        .modal { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            width: 90%; 
            max-width: 500px; 
            max-height: 80vh; 
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
        }
        .modal-header h3 { color: var(--primary); margin: 0; }
        .close-modal { 
            background: none; 
            border: none; 
            font-size: 28px; 
            cursor: pointer; 
            color: #64748b;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-modal:hover { color: var(--red); }
        
        .modal-details { margin: 20px 0; }
        .detail-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f5f9;
        }
        .detail-label { color: #64748b; font-size: 14px; font-weight: 600; }
        .detail-value { color: var(--text); font-size: 14px; text-align: right; }
        .detail-value.amount { font-weight: bold; font-size: 16px; }
        .detail-value.amount.bs { color: #1e40af; }
        .detail-value.amount.usd { color: #059669; }
        
        .modal-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #f1f5f9;
        }
        .modal-actions button { flex: 1; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ESTILOS DE IMPRESI√ìN */
        @media print {
            nav, header, .btn-print, button, input { display: none !important; }
            body, .container, .modulo { background: white; margin: 0; padding: 0; }
            .student-row { border: 1px solid #000; break-inside: avoid; }
            #mod-arch, #view-list, #final-list { display: block !important; }
        }
    </style>
</head>
<body>

<header>SISTEMA ADMINISTRATIVO SDJ (V16)</header>

<nav>
    <div class="nav-btn active" onclick="go('reg')">1. Registro</div>
    <div class="nav-btn" onclick="go('arch')">2. Archivos</div>
    <div class="nav-btn" onclick="go('pend')">3. Pendientes</div>
    <div class="nav-btn" onclick="go('solv')">4. Solventes</div>
    <div class="nav-btn" onclick="go('rep')">5. Reportes</div>
    <div class="nav-btn" onclick="go('padres')">6. Portal Padres</div>
</nav>

<div class="container">

    <!-- M√ìDULO REGISTRO -->
    <section id="mod-reg" class="modulo active">
        <div class="card">
            <h3>Registrar Alumno / Deuda</h3>
            <p style="font-size:12px; color:gray; margin-bottom:10px">* V16: Ahora incluye c√©dula del representante y c√°lculo autom√°tico.</p>
            
            <input type="text" id="rNom" placeholder="Nombre del Alumno *">
            <input type="text" id="rRep" placeholder="Nombre del Representante *">
            <input type="text" id="rCedula" placeholder="C√©dula del Representante *" pattern="[0-9]+" maxlength="10">
            <input type="email" id="rMail" placeholder="Correo (Opcional)">
            <input type="tel" id="rTel" placeholder="Tel√©fono (Ej: 584120000000)">
            
            <div style="display:flex; gap:10px">
                <select id="rGra">
                    <option>5to A√±o</option><option>4to A√±o</option><option>3er A√±o</option><option>2do A√±o</option><option>1er A√±o</option>
                    <option>6to Grado</option><option>5to Grado</option><option>4to Grado</option><option>3er Grado</option><option>2do Grado</option><option>1er Grado</option>
                    <option>Preescolar 3</option><option>Preescolar 2</option><option>Preescolar 1</option><option>Maternal</option>
                </select>
                <select id="rSec" style="width:100px"><option>A</option><option>B</option></select>
            </div>

            <label style="font-size:12px; font-weight:bold; margin-top:10px; display:block">Meses Pendientes:</label>
            <select id="rMes" multiple style="height:120px">
                <option value="Inscripci√≥n">Inscripci√≥n</option>
                <option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                <option value="Enero">Enero</option><option value="Febrero">Febrero</option><option value="Marzo">Marzo</option><option value="Abril">Abril</option>
                <option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option>
            </select>
            
            <input type="number" id="rMon" placeholder="Monto Mensual ($)">
            
            <div style="margin-top: 10px; padding: 10px; background: #f1f5f9; border-radius: 8px;">
                <small>Total calculado: <span id="totalPreview" style="font-weight:bold; color:#1e40af">$0</span></small>
            </div>
            
            <button class="btn-main" onclick="guardar()">GUARDAR REGISTRO V16</button>
        </div>
    </section>

    <!-- M√ìDULO ARCHIVOS -->
    <section id="mod-arch" class="modulo">
        <div id="view-level">
            <h3>Explorador de Archivos</h3>
            <div class="card" style="background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; margin-top:10px; text-align: center;">
                <small>DEUDA TOTAL DEL COLEGIO</small>
                <h2 id="global-debt" style="font-size: 28px;">Calculando...</h2>
            </div>

            <div class="folder-grid">
                <div class="folder" onclick="loadLevel('INICIAL')"><span class="icon">üìÇ</span>INICIAL</div>
                <div class="folder" onclick="loadLevel('PRIMARIA')"><span class="icon">üìÇ</span>PRIMARIA</div>
                <div class="folder" onclick="loadLevel('BACHILLERATO')"><span class="icon">üìÇ</span>BACHILLERATO</div>
            </div>
        </div>
        
        <div id="view-grade" style="display:none">
            <button onclick="resetArch()" style="margin-bottom:10px">‚¨Ö Atr√°s</button>
            <h3 id="tit-grade"></h3>
            <div id="grid-grade" class="folder-grid"></div>
        </div>
        
        <div id="view-sec" style="display:none">
            <button onclick="backToGrade()" style="margin-bottom:10px">‚¨Ö Atr√°s</button>
            <h3 id="tit-sec"></h3>
            <div class="folder-grid">
                <div class="folder" onclick="loadFinal('A')"><span class="icon">üìÅ</span>Secci√≥n A</div>
                <div class="folder" onclick="loadFinal('B')"><span class="icon">üìÅ</span>Secci√≥n B</div>
            </div>
        </div>
        
        <div id="view-list" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="backToSec()" style="margin-bottom:10px">‚¨Ö Atr√°s</button>
                <button class="btn-print" onclick="window.print()">üñ® Imprimir Lista</button>
            </div>
            
            <h3 id="tit-list"></h3>
            
            <div class="card" style="background:#fff7ed; border-color:#fed7aa; margin-top:10px; padding:15px;">
                <div style="text-align:right; margin-bottom:10px;">
                    <span id="sec-total-label" style="font-size:13px; color:#9a3412; font-weight:bold;">CALCULANDO DEUDA...</span>
                </div>
                <input type="text" id="search-filter" placeholder="üîç Buscar estudiante en esta secci√≥n..." onkeyup="filterList()" style="margin-top:0;">
            </div>

            <div class="card" style="margin-top:15px">
                <div id="final-list"></div>
            </div>
            
            <!-- FICHA DEL ESTUDIANTE (EDITABLE) -->
            <div id="ficha-estudiante" class="ficha-container" style="display:none;">
                <div class="card">
                    <h3>üìã Ficha del Estudiante</h3>
                    <div id="ficha-content">
                        <div style="margin-bottom: 15px;">
                            <label>Nombre del Alumno:</label>
                            <input type="text" id="edit-nombre" class="ficha-input">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Nombre del Representante:</label>
                            <input type="text" id="edit-representante" class="ficha-input">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>C√©dula del Representante:</label>
                            <input type="text" id="edit-cedula" class="ficha-input" readonly>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Tel√©fono:</label>
                            <input type="tel" id="edit-telefono" class="ficha-input">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Correo:</label>
                            <input type="email" id="edit-correo" class="ficha-input">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Grado y Secci√≥n:</label>
                            <input type="text" id="edit-grado" class="ficha-input" readonly>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Meses Pendientes:</label>
                            <div id="edit-meses" style="padding: 10px; background: #f8fafc; border-radius: 6px;"></div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label>Total Deuda:</label>
                            <h3 id="edit-total" style="color: #ef4444;"></h3>
                        </div>
                        <div class="ficha-actions">
                            <button class="btn-edit" onclick="guardarCambiosEstudiante()">üíæ Guardar Cambios</button>
                            <button class="btn-edit" onclick="volverALista()">‚¨Ö Volver a la Lista</button>
                            <button class="btn-delete" onclick="eliminarEstudiante()">üóë Eliminar Alumno</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- M√ìDULO PENDIENTES -->
    <section id="mod-pend" class="modulo">
        <button class="btn-critico" onclick="enviarAvisoCritico()">
            ‚ö†Ô∏è AVISO CR√çTICO (D√≠a 10) - Email Masivo
        </button>
        <button class="btn-alert-all" onclick="notifyAll()">
            üì¢ ENVIAR RECORDATORIOS (Email Individual)
        </button>
        
        <div class="card">
            <div id="list-pend">Cargando deudores...</div>
        </div>
    </section>

    <!-- M√ìDULO SOLVENTES -->
    <section id="mod-solv" class="modulo">
        <div class="card"><h3>Estudiantes al D√≠a</h3><div id="list-solv"></div></div>
    </section>

    <!-- M√ìDULO REPORTES - ACTUALIZADO -->
    <section id="mod-rep" class="modulo">
        <div class="card">
            <h3>üìä Pagos Reportados (V16)</h3>
            <p style="font-size:12px; color:gray; margin-bottom:10px">Haga clic en cualquier fila para ver todos los detalles del pago.</p>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Alumno / Representante</th>
                            <th>M√©todo / Referencia</th>
                            <th>Monto $</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="table-rep"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- PORTAL PADRES -->
    <section id="mod-padres" class="modulo">
        <div class="parent-portal">
            <h3 style="color:white; margin-bottom:15px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Portal para Padres</h3>
            <p style="font-size:14px; opacity:0.9;">Ingrese su c√©dula para consultar la situaci√≥n de todos sus hijos.</p>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <input type="text" id="cedula-consulta" placeholder="C√©dula del Representante" style="flex:1;">
                <button class="btn-main" onclick="consultarFamilia()" style="width:auto; padding:12px 25px;">üîç Consultar</button>
            </div>
        </div>
        
        <div id="resultados-familia" class="parent-results" style="display:none;">
            <div class="card">
                <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Resultados de la Consulta</h3>
                <div id="lista-hijos"></div>
                <div class="family-total" id="total-familiar"></div>
            </div>
        </div>
    </section>

</div>

<!-- MODAL PARA VER DETALLES DEL PAGO -->
<div id="modal-detalles-pago" class="modal-overlay" onclick="cerrarModalDetalles(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>üìã Detalles del Pago Reportado</h3>
            <button class="close-modal" onclick="cerrarModalDetalles()">√ó</button>
        </div>
        <div class="modal-details" id="detalles-pago-content">
            <!-- Contenido din√°mico -->
        </div>
        <div class="modal-actions">
            <button class="btn-check" onclick="validarPagoDesdeModal()">‚úÖ Verificar Pago</button>
            <button class="btn-reject" onclick="rechazarPagoDesdeModal()">‚úñ Rechazar</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, getDocs, query, where, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_m1k2Vlu5QTokgjNZ6czlI2XH1YTC3U8",
        authDomain: "reportedepagos-d8485.firebaseapp.com",
        projectId: "reportedepagos-d8485",
        storageBucket: "reportedepagos-d8485.appspot.com",
        messagingSenderId: "335664812002",
        appId: "1:335664812002:web:609ecb3008145281af3bb8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    const DB_MAIN = "sdj_final_v16"; 
    const DB_PAGOS = "pagos_reportados";
    const DB_HISTORIAL = "historial_pagos";

    const ORDEN_GRADOS = [
        "5to A√±o", "4to A√±o", "3er A√±o", "2do A√±o", "1er A√±o",
        "6to Grado", "5to Grado", "4to Grado", "3er Grado", "2do Grado", "1er Grado",
        "Preescolar 3", "Preescolar 2", "Preescolar 1", "Maternal"
    ];

    // Variables globales
    let cachePendientes = [];
    let cacheTodosEstudiantes = [];
    let estudianteActual = null;
    let pagoSeleccionado = null;
    let curLvl = "", curGra = "", curSec = "";
    
    const struct = {
        'INICIAL': ['Maternal', 'Preescolar 1', 'Preescolar 2', 'Preescolar 3'],
        'PRIMARIA': ['1er Grado','2do Grado','3er Grado','4to Grado','5to Grado','6to Grado'],
        'BACHILLERATO': ['1er A√±o','2do A√±o','3er A√±o','4to A√±o','5to A√±o']
    };

    // 1. CORRECCI√ìN DEL ERROR DE DEUDA $0
    document.getElementById('rMes').addEventListener('change', calcularTotal);
    document.getElementById('rMon').addEventListener('input', calcularTotal);

    function calcularTotal() {
        const mesesSeleccionados = Array.from(document.getElementById('rMes').selectedOptions).map(o => o.value);
        const montoMensual = parseFloat(document.getElementById('rMon').value) || 0;
        const total = mesesSeleccionados.length * montoMensual;
        document.getElementById('totalPreview').innerText = `$${total}`;
    }

    window.go = (id) => {
        document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mod-'+id).classList.add('active');
        event.currentTarget.classList.add('active');
    };

    window.guardar = async () => {
        const meses = Array.from(document.getElementById('rMes').selectedOptions).map(o => o.value);
        const montoMensual = parseFloat(document.getElementById('rMon').value) || 0;
        const total = meses.length * montoMensual;
        
        if (!document.getElementById('rCedula').value) {
            alert("Por favor ingrese la c√©dula del representante");
            return;
        }
        
        await addDoc(collection(db, DB_MAIN), {
            nombre: document.getElementById('rNom').value,
            rep: document.getElementById('rRep').value,
            cedula: document.getElementById('rCedula').value,
            mail: document.getElementById('rMail').value,
            tel: document.getElementById('rTel').value,
            grado: document.getElementById('rGra').value,
            seccion: document.getElementById('rSec').value,
            meses: meses,
            montoMensual: montoMensual,
            total: total,
            historial: [],
            timestamp: new Date()
        });
        alert("¬°Registro Exitoso V16!");
        document.getElementById('rNom').value = '';
        document.getElementById('rRep').value = '';
        document.getElementById('rCedula').value = '';
        document.getElementById('rMail').value = '';
        document.getElementById('rTel').value = '';
        document.getElementById('rMon').value = '';
        document.getElementById('rMes').selectedIndex = -1;
        document.getElementById('totalPreview').innerText = '$0';
    };

    // SNAPSHOT PRINCIPAL para pendientes y solventes
    onSnapshot(collection(db, DB_MAIN), (snap) => {
        const lp = document.getElementById('list-pend');
        const ls = document.getElementById('list-solv');
        const globalDebt = document.getElementById('global-debt');
        
        lp.innerHTML = ""; 
        ls.innerHTML = "";
        cachePendientes = [];
        cacheTodosEstudiantes = [];
        let totalColegio = 0;

        let allData = [];
        snap.forEach(d => {
            const data = d.data();
            allData.push({ ...data, id: d.id });
            cacheTodosEstudiantes.push({ ...data, id: d.id });
        });

        // PENDIENTES
        ORDEN_GRADOS.forEach(grado => {
            const grupo = allData.filter(x => x.grado === grado && x.meses && x.meses.length > 0);
            if(grupo.length > 0) {
                lp.innerHTML += `<div class="grado-header">${grado}</div>`;
                grupo.forEach(a => {
                    const totalDeuda = (a.montoMensual || 0) * (a.meses ? a.meses.length : 0);
                    const alerta = getNivelAlerta(a.meses.length);
                    cachePendientes.push({ ...a, tipoAlerta: alerta.tipo, total: totalDeuda });
                    totalColegio += totalDeuda;

                    let wsBtn = "";
                    let emailBtn = "";
                    
                    if(a.tel) {
                        const mesesTexto = a.meses.join(', ');
                        const msg = `Buenas tardes de parte del colegio Santiago de Jes√∫s se le informa que su representado ${a.nombre} debe ${mesesTexto} para un total de $${totalDeuda}.`;
                        wsBtn = `<button class="btn-ws" onclick="enviarWhatsApp('${a.tel}', '${a.nombre}', '${mesesTexto}', ${totalDeuda})">üì±</button>`;
                    }
                    
                    if(a.mail) {
                        emailBtn = `<button class="btn-email" onclick="enviarGmailIndividual('${a.mail}', '${a.nombre}', '${a.rep}', ${totalDeuda}, '${a.meses.join(', ')}')">‚úâÔ∏è</button>`;
                    }

                    lp.innerHTML += `
                        <div class="student-row alert-${alerta.clase}">
                            <div class="info">
                                <span class="badge bg-${alerta.clase}">${alerta.texto}</span>
                                <b>${a.nombre} (${a.seccion})</b>
                                <small>${a.rep} - C.I. ${a.cedula || 'No registrada'}</small>
                                <div>${a.meses.map(m => `<span class="tag-mes">${m}</span>`).join('')}</div>
                            </div>
                            <div style="text-align:right">
                                <b style="color:#ef4444">$${totalDeuda}</b><br>
                                <div style="margin-top:5px">
                                    ${wsBtn}
                                    ${emailBtn}
                                </div>
                                <button onclick="del('${a.id}')" style="font-size:10px; color:gray; border:none; background:none; cursor:pointer; margin-top:5px">Eliminar</button>
                            </div>
                        </div>`;
                });
            }
        });

        // SOLVENTES
        const solventes = allData.filter(x => !x.meses || x.meses.length === 0);
        solventes.forEach(a => {
            ls.innerHTML += `
                <div class="student-row" style="border-left:5px solid var(--green)">
                    <div class="info">
                        <b>${a.nombre}</b>
                        <small>${a.grado} (${a.seccion}) - ${a.rep}</small>
                    </div>
                    <b style="color:var(--green)">SOLVENTE</b>
                </div>`;
        });

        if(solventes.length === 0) {
            ls.innerHTML = '<p style="text-align:center; padding:20px; color:gray">No hay estudiantes solventes</p>';
        }

        if(globalDebt) globalDebt.innerText = `$${totalColegio.toLocaleString()}`;
    });

    // SNAPSHOT PARA REPORTES - ACTUALIZADO CON MODAL
    onSnapshot(collection(db, DB_PAGOS), (snap) => {
        const tb = document.getElementById('table-rep'); 
        tb.innerHTML = "";
        
        if(snap.empty) {
            tb.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center; padding:40px; color:#64748b;">
                        <div style="font-size:50px;">üì≠</div>
                        <h4>No hay pagos reportados</h4>
                        <small>Los padres a√∫n no han reportado ning√∫n pago.</small>
                    </td>
                </tr>
            `;
            return;
        }
        
        let contador = 0;
        snap.forEach(d => {
            const p = d.data();
            contador++;
            
            // Determinar color del estado
            let estadoColor = '#64748b';
            let estadoTexto = p.estado || 'Pendiente';
            
            if(estadoTexto.includes('Pendiente')) estadoColor = '#eab308';
            if(estadoTexto.includes('Verificado')) estadoColor = '#22c55e';
            if(estadoTexto.includes('Rechazado')) estadoColor = '#ef4444';
            
            // Formatear fecha
            let fechaFormateada = 'Sin fecha';
            if(p.fechaPago) {
                const fecha = new Date(p.fechaPago);
                fechaFormateada = fecha.toLocaleDateString('es-ES');
            } else if(p.timestamp) {
                const fecha = p.timestamp.toDate();
                fechaFormateada = fecha.toLocaleDateString('es-ES');
            }
            
            tb.innerHTML += `
                <tr class="clickable-row" data-id="${d.id}" onclick="mostrarDetallesPago('${d.id}')">
                    <td>
                        <strong>${p.nombreEst || 'Sin nombre'}</strong><br>
                        <small style="color:#64748b;">${p.nombreRep || 'Sin representante'}</small><br>
                        <small style="font-size:10px; color:#94a3b8;">${fechaFormateada}</small>
                    </td>
                    <td>
                        <strong style="color:#1e40af;">${p.metodo || 'Sin m√©todo'}</strong><br>
                        <small>${p.referencia || 'Sin referencia'}</small><br>
                        <small style="color:#64748b;">${p.banco || ''}</small>
                    </td>
                    <td>
                        <strong style="color:#059669;">$${p.montoDivisas || p.monto || '0'}</strong><br>
                        <small style="color:#1e40af;">Bs. ${p.montoBs || '0'}</small>
                    </td>
                    <td>
                        <span style="color:${estadoColor}; font-weight:bold; font-size:11px;">
                            ${estadoTexto}
                        </span>
                    </td>
                    <td>
                        <button class="btn-check" onclick="event.stopPropagation(); validarPago('${d.id}')">‚úî</button>
                        <button class="btn-reject" onclick="event.stopPropagation(); rechazar('${d.id}','${p.referencia}')">‚úñ</button>
                    </td>
                </tr>
            `;
        });
    });

    // FUNCI√ìN PARA MOSTRAR DETALLES COMPLETOS DEL PAGO (MODAL)
    window.mostrarDetallesPago = async (idPago) => {
        try {
            const docRef = doc(db, DB_PAGOS, idPago);
            const docSnap = await getDoc(docRef);
            
            if(!docSnap.exists()) {
                alert("El pago no existe");
                return;
            }
            
            pagoSeleccionado = { id: idPago, ...docSnap.data() };
            
            // Formatear fecha
            let fechaFormateada = 'No especificada';
            if(pagoSeleccionado.fechaPago) {
                const fecha = new Date(pagoSeleccionado.fechaPago);
                fechaFormateada = fecha.toLocaleDateString('es-ES') + ' ' + fecha.toLocaleTimeString('es-ES');
            } else if(pagoSeleccionado.timestamp) {
                const fecha = pagoSeleccionado.timestamp.toDate();
                fechaFormateada = fecha.toLocaleDateString('es-ES') + ' ' + fecha.toLocaleTimeString('es-ES');
            }
            
            // Determinar estado y color
            let estadoColor = '#64748b';
            let estadoTexto = pagoSeleccionado.estado || 'Pendiente de verificaci√≥n';
            
            if(estadoTexto.includes('Pendiente')) estadoColor = '#eab308';
            if(estadoTexto.includes('Verificado')) estadoColor = '#22c55e';
            if(estadoTexto.includes('Rechazado')) estadoColor = '#ef4444';
            
            // Construir contenido del modal
            const contenido = `
                <div class="detail-row">
                    <span class="detail-label">Estudiante:</span>
                    <span class="detail-value">${pagoSeleccionado.nombreEst || 'No especificado'}</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Representante:</span>
                    <span class="detail-value">${pagoSeleccionado.nombreRep || 'No especificado'}</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">C√©dula:</span>
                    <span class="detail-value">${pagoSeleccionado.cedulaRep || 'No registrada'}</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">M√©todo de pago:</span>
                    <span class="detail-value"><strong>${pagoSeleccionado.metodo || 'No especificado'}</strong></span>
                </div>
                
                ${pagoSeleccionado.banco ? `
                <div class="detail-row">
                    <span class="detail-label">Banco:</span>
                    <span class="detail-value">${pagoSeleccionado.banco}</span>
                </div>
                ` : ''}
                
                ${pagoSeleccionado.referencia ? `
                <div class="detail-row">
                    <span class="detail-label">Referencia:</span>
                    <span class="detail-value">${pagoSeleccionado.referencia}</span>
                </div>
                ` : ''}
                
                ${pagoSeleccionado.cuenta ? `
                <div class="detail-row">
                    <span class="detail-label">Cuenta/RIF:</span>
                    <span class="detail-value">${pagoSeleccionado.cuenta}</span>
                </div>
                ` : ''}
                
                <div class="detail-row">
                    <span class="detail-label">Monto en Bol√≠vares:</span>
                    <span class="detail-value amount bs">Bs. ${pagoSeleccionado.montoBs || '0.00'}</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Monto en D√≥lares:</span>
                    <span class="detail-value amount usd">$ ${pagoSeleccionado.montoDivisas || pagoSeleccionado.monto || '0.00'}</span>
                </div>
                
                ${pagoSeleccionado.mesesPagados && pagoSeleccionado.mesesPagados.length > 0 ? `
                <div class="detail-row">
                    <span class="detail-label">Meses pagados:</span>
                    <span class="detail-value">
                        ${Array.isArray(pagoSeleccionado.mesesPagados) ? 
                            pagoSeleccionado.mesesPagados.join(', ') : 
                            pagoSeleccionado.mesesPagados}
                    </span>
                </div>
                ` : ''}
                
                <div class="detail-row">
                    <span class="detail-label">Fecha del pago:</span>
                    <span class="detail-value">${fechaFormateada}</span>
                </div>
                
                ${pagoSeleccionado.observaciones ? `
                <div class="detail-row">
                    <span class="detail-label">Observaciones:</span>
                    <span class="detail-value">${pagoSeleccionado.observaciones}</span>
                </div>
                ` : ''}
                
                <div class="detail-row">
                    <span class="detail-label">Estado:</span>
                    <span class="detail-value" style="color:${estadoColor}; font-weight:bold;">
                        ${estadoTexto}
                    </span>
                </div>
            `;
            
            document.getElementById('detalles-pago-content').innerHTML = contenido;
            document.getElementById('modal-detalles-pago').style.display = 'flex';
            
        } catch (error) {
            console.error("Error al cargar detalles:", error);
            alert("Error al cargar los detalles del pago");
        }
    };

    // FUNCIONES DEL MODAL
    window.cerrarModalDetalles = function(e) {
        if(e && e.target.id === 'modal-detalles-pago') {
            document.getElementById('modal-detalles-pago').style.display = 'none';
        } else if(!e) {
            document.getElementById('modal-detalles-pago').style.display = 'none';
        }
    };

    window.validarPagoDesdeModal = async function() {
        if(!pagoSeleccionado) return;
        
        if(confirm(`¬øVerificar el pago de ${pagoSeleccionado.nombreEst || 'este estudiante'}?`)) {
            await validarPago(pagoSeleccionado.id);
            document.getElementById('modal-detalles-pago').style.display = 'none';
        }
    };

    window.rechazarPagoDesdeModal = async function() {
        if(!pagoSeleccionado) return;
        
        if(confirm(`¬øRechazar el pago de ${pagoSeleccionado.nombreEst || 'este estudiante'}?`)) {
            await rechazar(pagoSeleccionado.id, pagoSeleccionado.referencia || '');
            document.getElementById('modal-detalles-pago').style.display = 'none';
        }
    };

    // FUNCIONES DE ARCHIVOS
    window.loadLevel = (l) => {
        curLvl = l;
        document.getElementById('view-level').style.display='none';
        document.getElementById('view-grade').style.display='block';
        document.getElementById('tit-grade').innerText = l;
        const grid = document.getElementById('grid-grade'); 
        grid.innerHTML = "";
        struct[l].forEach(g => grid.innerHTML += `<div class="folder" onclick="loadSec('${g}')">üìÅ<br>${g}</div>`);
    };

    window.loadSec = (g) => { 
        curGra = g; 
        document.getElementById('view-grade').style.display='none'; 
        document.getElementById('view-sec').style.display='block'; 
        document.getElementById('tit-sec').innerText = g; 
    };

    window.loadFinal = (s) => {
        curSec = s;
        document.getElementById('view-sec').style.display='none';
        document.getElementById('view-list').style.display='block';
        document.getElementById('ficha-estudiante').style.display = 'none';
        document.getElementById('tit-list').innerText = `${curGra} - SECCI√ìN ${s}`;
        document.getElementById('search-filter').value = "";
        
        document.getElementById('final-list').innerHTML = "Cargando...";
        document.getElementById('sec-total-label').innerHTML = "Calculando...";

        onSnapshot(collection(db, DB_MAIN), (snap) => {
            const div = document.getElementById('final-list'); 
            const labelTotal = document.getElementById('sec-total-label');
            div.innerHTML = "";
            
            let deudaAcumulada = 0;
            let contador = 0;

            snap.forEach(d => {
                const a = d.data();
                if(a.grado === curGra && a.seccion === s) {
                    contador++;
                    const total = (a.montoMensual || 0) * (a.meses ? a.meses.length : 0);
                    const esSolvente = (!a.meses || a.meses.length === 0);
                    
                    if(!esSolvente) deudaAcumulada += total;

                    div.innerHTML += `
                    <div class="student-row item-lista" data-id="${d.id}" data-name="${a.nombre.toLowerCase()}" onclick="mostrarFichaEstudiante('${d.id}')" style="cursor:pointer; ${esSolvente ? 'border-left: 6px solid var(--green)' : 'border-left: 6px solid var(--red)'}">
                        <div class="info">
                            <b>${a.nombre}</b>
                            <small>${a.rep} - ${a.cedula || 'Sin c√©dula'}</small>
                            ${!esSolvente ? `<div>${a.meses.map(m => `<span class="tag-mes">${m}</span>`).join('')}</div>` : ''}
                        </div>
                        <div style="text-align:right">
                            ${esSolvente ? 
                                `<b style="color:var(--green)">SOLVENTE</b>` : 
                                `<b style="color:var(--red)">DEUDA</b><br><span style="font-size:11px; color:#ef4444">$${total}</span>`}
                        </div>
                    </div>`;
                }
            });

            if(deudaAcumulada > 0) {
                labelTotal.innerHTML = `TOTAL PENDIENTE SECCI√ìN: <span style="font-size:16px; color:#ef4444">$${deudaAcumulada}</span> (${contador} estudiantes)`;
            } else {
                labelTotal.innerHTML = `<span style="color:var(--green)">SECCI√ìN SOLVENTE ($0)</span> (${contador} estudiantes)`;
            }

            if(contador === 0) div.innerHTML = "<p style='text-align:center; padding:20px; color:gray'>Carpeta Vac√≠a</p>";
        });
    };

    // FICHA DEL ESTUDIANTE
    window.mostrarFichaEstudiante = async (id) => {
        const estudiantes = await getDocs(collection(db, DB_MAIN));
        
        estudiantes.forEach(d => {
            if(d.id === id) {
                estudianteActual = { ...d.data(), id: d.id };
                
                document.getElementById('edit-nombre').value = estudianteActual.nombre;
                document.getElementById('edit-representante').value = estudianteActual.rep;
                document.getElementById('edit-cedula').value = estudianteActual.cedula || '';
                document.getElementById('edit-telefono').value = estudianteActual.tel || '';
                document.getElementById('edit-correo').value = estudianteActual.mail || '';
                document.getElementById('edit-grado').value = `${estudianteActual.grado} - ${estudianteActual.seccion}`;
                
                const mesesDiv = document.getElementById('edit-meses');
                if(estudianteActual.meses && estudianteActual.meses.length > 0) {
                    mesesDiv.innerHTML = estudianteActual.meses.map(m => 
                        `<span class="tag-mes" style="margin:2px; display:inline-block;">${m}</span>`
                    ).join('');
                } else {
                    mesesDiv.innerHTML = '<span style="color:var(--green)">Sin deudas</span>';
                }
                
                const total = (estudianteActual.montoMensual || 0) * (estudianteActual.meses ? estudianteActual.meses.length : 0);
                document.getElementById('edit-total').innerHTML = `$${total}`;
                
                document.getElementById('final-list').style.display = 'none';
                document.getElementById('ficha-estudiante').style.display = 'block';
            }
        });
    };

    window.guardarCambiosEstudiante = async () => {
        if(!estudianteActual) return;
        
        try {
            await updateDoc(doc(db, DB_MAIN, estudianteActual.id), {
                rep: document.getElementById('edit-representante').value,
                tel: document.getElementById('edit-telefono').value,
                mail: document.getElementById('edit-correo').value
            });
            
            alert("‚úÖ Cambios guardados exitosamente");
            loadFinal(curSec);
        } catch (error) {
            alert("Error al guardar cambios: " + error.message);
        }
    };

    window.volverALista = () => {
        document.getElementById('final-list').style.display = 'block';
        document.getElementById('ficha-estudiante').style.display = 'none';
    };

    window.eliminarEstudiante = async () => {
        if(!estudianteActual) return;
        
        if(confirm(`¬øEst√° seguro de eliminar a ${estudianteActual.nombre}? Esta acci√≥n no se puede deshacer.`)) {
            try {
                await deleteDoc(doc(db, DB_MAIN, estudianteActual.id));
                alert("‚úÖ Estudiante eliminado");
                volverALista();
                loadFinal(curSec);
            } catch (error) {
                alert("Error al eliminar: " + error.message);
            }
        }
    };

    window.filterList = () => {
        const term = document.getElementById('search-filter').value.toLowerCase();
        const items = document.querySelectorAll('.item-lista');
        items.forEach(item => {
            const name = item.getAttribute('data-name');
            item.style.display = name.includes(term) ? "flex" : "none";
        });
    };
    
    window.resetArch = () => { 
        document.getElementById('view-grade').style.display='none'; 
        document.getElementById('view-level').style.display='block'; 
    };
    
    window.backToGrade = () => { 
        document.getElementById('view-sec').style.display='none'; 
        document.getElementById('view-grade').style.display='block'; 
    };
    
    window.backToSec = () => { 
        document.getElementById('view-list').style.display='none'; 
        document.getElementById('ficha-estudiante').style.display = 'none';
        document.getElementById('view-sec').style.display='block'; 
    };

    // PORTAL DE PADRES
    window.consultarFamilia = async () => {
        const cedula = document.getElementById('cedula-consulta').value.trim();
        if(!cedula) {
            alert("Por favor ingrese su c√©dula");
            return;
        }
        
        const estudiantes = await getDocs(collection(db, DB_MAIN));
        const hijos = [];
        let totalFamiliar = 0;
        let representanteNombre = '';
        
        estudiantes.forEach(d => {
            const data = d.data();
            if(data.cedula === cedula) {
                if(!representanteNombre && data.rep) {
                    representanteNombre = data.rep;
                }
                
                const total = (data.montoMensual || 0) * (data.meses ? data.meses.length : 0);
                hijos.push({
                    nombre: data.nombre,
                    grado: data.grado,
                    seccion: data.seccion,
                    meses: data.meses || [],
                    total: total,
                    solvente: (!data.meses || data.meses.length === 0)
                });
                
                if(!data.meses || data.meses.length > 0) {
                    totalFamiliar += total;
                }
            }
        });
        
        const resultadosDiv = document.getElementById('resultados-familia');
        const listaHijosDiv = document.getElementById('lista-hijos');
        const totalFamiliarDiv = document.getElementById('total-familiar');
        
        if(hijos.length === 0) {
            listaHijosDiv.innerHTML = `
                <div style="text-align:center; padding:20px; color:gray">
                    <p>No se encontraron estudiantes asociados a esta c√©dula.</p>
                    <p>C√©dula consultada: ${cedula}</p>
                </div>
            `;
        } else {
            listaHijosDiv.innerHTML = `
                <h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Representante: ${representanteNombre || 'No registrado'}</h4>
                <p style="font-size:12px; color:#64748b; margin-bottom:15px;">C√©dula: ${cedula} - ${hijos.length} hijo(s) registrado(s)</p>
                <div style="margin-top:15px;">
                    ${hijos.map((hijo, index) => `
                        <div class="student-row" style="margin-bottom:10px; ${hijo.solvente ? 'border-left: 5px solid var(--green)' : 'border-left: 5px solid var(--red)'}">
                            <div class="info">
                                <b>${hijo.nombre}</b>
                                <small>${hijo.grado} - Secci√≥n ${hijo.seccion}</small>
                                ${!hijo.solvente ? `
                                    <div style="margin-top:5px;">
                                        ${hijo.meses.map(m => `<span class="tag-mes">${m}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="text-align:right">
                                ${hijo.solvente ? 
                                    '<b style="color:var(--green)">AL D√çA</b>' : 
                                    `<b style="color:var(--red)">$${hijo.total}</b>`}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        totalFamiliarDiv.innerHTML = totalFamiliar > 0 ? 
            `TOTAL DEUDA FAMILIAR: $${totalFamiliar}` : 
            'üéâ FAMILIA COMPLETAMENTE SOLVENTE';
        
        resultadosDiv.style.display = 'block';
    };

    function getNivelAlerta(meses) {
        const dia = new Date().getDate();
        if (meses >= 3 || (meses >= 1 && dia > 10)) {
            return { texto: "ALERTA URGENTE", clase: "urgente", tipo: "urgente" };
        } else if (meses === 2) {
            return { texto: "ALERTA NORMAL", clase: "normal", tipo: "normal" };
        } else {
            return { texto: "ALERTA PREVIA", clase: "previa", tipo: "previa" };
        }
    }

    // 3. M√ìDULO DE COBRANZA MEJORADO
    window.enviarWhatsApp = (telefono, nombre, meses, monto) => {
        const mensaje = `Buenas tardes de parte del colegio Santiago de Jes√∫s se le informa que su representado ${nombre} debe ${meses} para un total de $${monto}.`;
        window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, '_blank');
    };

    window.enviarGmailIndividual = (email, nombre, representante, monto, meses) => {
        const asunto = "Recordatorio de Pago - Colegio Santiago de Jes√∫s";
        const cuerpo = `Estimado Sr(a) ${representante},

Le escribimos del Colegio Santiago de Jes√∫s para recordarle el pago pendiente:

Estudiante: ${nombre}
Meses pendientes: ${meses}
Total adeudado: $${monto}

Por favor regularizar su situaci√≥n lo antes posible.

Atentamente,
Administraci√≥n
Colegio Santiago de Jes√∫s`;
        
        window.location.href = `mailto:${email}?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
    };

    window.enviarAvisoCritico = () => {
        const dia = new Date().getDate();
        if (dia < 10) {
            alert("El aviso cr√≠tico solo se puede enviar a partir del d√≠a 10 del mes.");
            return;
        }

        if(cachePendientes.length === 0) {
            alert("No hay deudores para enviar aviso cr√≠tico.");
            return;
        }

        const correos = cachePendientes
            .filter(a => a.mail)
            .map(a => a.mail)
            .join(',');
        
        if(!correos) {
            alert("No hay correos registrados para enviar aviso masivo.");
            return;
        }

        const asunto = "AVISO CR√çTICO - Colegio Santiago de Jes√∫s (D√≠a " + dia + ")";
        const cuerpo = `Estimados representantes,

ESTE ES UN AVISO CR√çTICO DE COBRANZA

A la fecha (d√≠a ${dia} del mes), su(s) representado(s) presenta(n) deuda pendiente en nuestra instituci√≥n.

Por favor acercarse a la administraci√≥n a la mayor brevedad posible para regularizar su situaci√≥n y evitar consecuencias acad√©micas.

Total de deudores en esta lista: ${cachePendientes.length}

Atentamente,
Administraci√≥n
Colegio Santiago de Jes√∫s`;

        window.location.href = `mailto:${correos}?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
    };

    window.notifyAll = () => {
        if(cachePendientes.length === 0) {
            alert("No hay deudores para enviar recordatorios.");
            return;
        }

        if(confirm(`¬øEnviar correos individuales a ${cachePendientes.length} representantes?`)) {
            cachePendientes.forEach((a, i) => { 
                setTimeout(() => {
                    if(a.mail) {
                        enviarGmailIndividual(a.mail, a.nombre, a.rep, a.total, a.meses.join(', '));
                    }
                }, i * 1000);
            });
        }
    };

    // FUNCIONES DE VALIDACI√ìN Y RECHAZO
    window.validarPago = async function(id) {
        const docRef = doc(db, DB_PAGOS, id);
        const docSnap = await getDoc(docRef);
        
        if(!docSnap.exists()) {
            alert("El pago no existe");
            return;
        }
        
        const pagoData = docSnap.data();
        
        const confirmacion = confirm(`¬øVerificar el pago de ${pagoData.nombreEst}?\n\nM√©todo: ${pagoData.metodo}\nReferencia: ${pagoData.referencia || 'N/A'}\nMonto: $${pagoData.montoDivisas || pagoData.monto || '0'}`);
        
        if(confirmacion) {
            try {
                const estudiantesQuery = query(collection(db, DB_MAIN), where("nombre", "==", pagoData.nombreEst));
                const estudiantesSnap = await getDocs(estudiantesQuery);
                
                if(!estudiantesSnap.empty) {
                    estudiantesSnap.forEach(async (estDoc) => {
                        const estudianteData = estDoc.data();
                        
                        const registroHistorial = {
                            fecha: new Date(),
                            montoBs: pagoData.montoBs || 0,
                            montoDolares: pagoData.montoDivisas || pagoData.monto || 0,
                            metodoPago: pagoData.metodo || '',
                            referencia: pagoData.referencia || '',
                            banco: pagoData.banco || '',
                            cuenta: pagoData.cuenta || '',
                            mesesPagados: pagoData.mesesPagados || [],
                            descripcion: `Pago verificado - ${pagoData.metodo || ''}`
                        };
                        
                        const historialActual = estudianteData.historial || [];
                        historialActual.push(registroHistorial);
                        
                        let nuevosMeses = estudianteData.meses || [];
                        if(pagoData.mesesPagados && pagoData.mesesPagados.length > 0) {
                            if(Array.isArray(pagoData.mesesPagados)) {
                                nuevosMeses = nuevosMeses.filter(mes => !pagoData.mesesPagados.includes(mes));
                            }
                        }
                        
                        const nuevoTotal = (estudianteData.montoMensual || 0) * nuevosMeses.length;
                        
                        await updateDoc(doc(db, DB_MAIN, estDoc.id), {
                            historial: historialActual,
                            meses: nuevosMeses,
                            total: nuevoTotal
                        });
                        
                        await addDoc(collection(db, DB_HISTORIAL), {
                            ...registroHistorial,
                            estudianteId: estDoc.id,
                            estudianteNombre: pagoData.nombreEst,
                            representanteNombre: pagoData.nombreRep,
                            cedulaRepresentante: pagoData.cedulaRep,
                            reporteId: id,
                            timestamp: new Date()
                        });
                    });
                }
                
                await deleteDoc(docRef);
                alert("‚úÖ Pago verificado exitosamente");
                
            } catch (error) {
                console.error("Error al verificar pago:", error);
                alert("Error al verificar el pago: " + error.message);
            }
        }
    };

    window.rechazar = async(id, ref) => {
        const motivo = prompt("Ingrese el motivo del rechazo (opcional):");
        
        if(motivo !== null) {
            try {
                await updateDoc(doc(db, DB_PAGOS, id), {
                    estado: `Rechazado - ${motivo || 'Sin motivo especificado'}`
                });
                
                alert("‚úÖ Pago marcado como rechazado");
                
                if(confirm("¬øEnviar correo al representante informando el rechazo?")) {
                    window.location.href = `mailto:?subject=Rechazo de pago SDJ&body=La referencia ${ref} fue rechazada. Motivo: ${motivo || 'No especificado'}`;
                }
                
            } catch (error) {
                console.error("Error al rechazar pago:", error);
                alert("Error al rechazar el pago");
            }
        }
    };

    window.del = async(id) => { 
        if(confirm("¬øEliminar Alumno?")) await deleteDoc(doc(db, DB_MAIN, id)); 
    };

    // Inicializar c√°lculo de total
    calcularTotal();
</script>
</body>
</html>

