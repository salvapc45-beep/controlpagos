<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA INTEGRAL SDJ - VERSI√ìN COMPLETA</title>
    <style>
        :root {
            --primary: #1e3a8a; --accent: #3b82f6; --bg: #f1f5f9;
            --folder: #fcd34d; --success: #10b981; --danger: #ef4444; --text: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }

        header { background: var(--primary); color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 1.3rem; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        /* BARRA DE NAVEGACI√ìN DE 5 APARTADOS */
        nav { 
            display: flex; background: white; border-bottom: 2px solid #cbd5e1; 
            position: sticky; top: 0; z-index: 1000; overflow-x: auto;
        }
        .nav-btn { 
            flex: 1; min-width: 110px; padding: 18px 5px; text-align: center; 
            cursor: pointer; font-weight: bold; color: #64748b; font-size: 11px;
            border-bottom: 4px solid transparent; transition: 0.3s; text-transform: uppercase;
        }
        .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8fafc; }

        .container { max-width: 1200px; margin: 25px auto; padding: 0 15px; }
        .modulo { display: none; }
        .modulo.active { display: block; animation: slideUp 0.4s ease-out; }

        /* CARPETAS Y ARCHIVADOR */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; margin-top: 10px; }
        .folder { 
            background: white; border: 1px solid #e2e8f0; border-radius: 15px; padding: 25px 15px; 
            text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .folder:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .folder-icon { font-size: 45px; color: var(--folder); display: block; margin-bottom: 10px; }
        .folder b { font-size: 13px; color: var(--primary); }

        /* TABLA DE REPORTES BANCARIOS */
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .table-container { overflow-x: auto; margin-top: 15px; }
        .report-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .report-table th { background: #f8fafc; padding: 15px; text-align: left; color: #475569; font-size: 12px; border-bottom: 2px solid #e2e8f0; }
        .report-table td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        
        .bank-tag { background: #dbeafe; color: #1e40af; padding: 5px 10px; border-radius: 6px; font-weight: bold; font-size: 11px; }
        .price-bs { color: #2563eb; font-weight: bold; }
        .price-dl { color: #16a34a; font-weight: bold; }

        /* ESTUDIANTES */
        .student-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px; background: white; border-radius: 12px; border: 1px solid #e2e8f0; 
            margin-bottom: 12px; border-left: 6px solid #cbd5e1;
        }
        .student-item.debtor { border-left-color: var(--danger); background: #fff1f2; }
        .tag-mes { background: #fee2e2; color: #b91c1c; padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: bold; margin-right: 4px; display: inline-block; margin-top: 5px; }

        /* FORMULARIO */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 12px; font-weight: 700; color: #334155; margin-bottom: 8px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; transition: 0.3s; }
        input:focus { border-color: var(--accent); outline: none; }
        .btn-action { background: var(--primary); color: white; width: 100%; padding: 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 15px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>SISTEMA ADMINISTRATIVO SDJ - CONTROL CENTRAL</header>

<nav>
    <div class="nav-btn active" onclick="tab('reg')">1. Registro</div>
    <div class="nav-btn" onclick="tab('arch')">2. Archivos</div>
    <div class="nav-btn" onclick="tab('pend')">3. Pendientes</div>
    <div class="nav-btn" onclick="tab('solv')">4. Solventes</div>
    <div class="nav-btn" onclick="tab('valid')">5. Reportes</div>
</nav>

<div class="container">

    <section id="mod-reg" class="modulo active">
        <div class="card">
            <h2 style="margin-bottom:20px">Inscripci√≥n de Estudiante</h2>
            <div class="form-group"><label>Nombre Completo del Estudiante</label><input type="text" id="inNom" placeholder="Ej: Juan P√©rez"></div>
            <div class="form-group"><label>Nombre del Representante</label><input type="text" id="inRep" placeholder="Nombre de padre/madre"></div>
            <div class="form-group"><label>Correo Electr√≥nico</label><input type="email" id="inMail" placeholder="correo@ejemplo.com"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                <div class="form-group">
                    <label>Grado / A√±o</label>
                    <select id="inGra">
                        <option>Maternal</option><option>Preescolar 1</option><option>Preescolar 2</option><option>Preescolar 3</option>
                        <option>1er Grado</option><option>2do Grado</option><option>3er Grado</option><option>4to Grado</option><option>5to Grado</option><option>6to Grado</option>
                        <option>1er A√±o</option><option>2do A√±o</option><option>3er A√±o</option><option>4to A√±o</option><option>5to A√±o</option>
                    </select>
                </div>
                <div class="form-group"><label>Secci√≥n</label><select id="inSec"><option value="A">Secci√≥n A</option><option value="B">Secci√≥n B</option></select></div>
            </div>
            <div class="form-group">
                <label>Meses que Adeuda (Selecci√≥n M√∫ltiple)</label>
                <select id="inMes" multiple style="height:150px">
                    <option value="Inscripci√≥n">Inscripci√≥n</option>
                    <option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                    <option value="Enero">Enero</option><option value="Febrero">Febrero</option><option value="Marzo">Marzo</option><option value="Abril">Abril</option>
                    <option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option>
                </select>
                <p style="font-size:11px; color:gray; margin-top:5px">* Si el estudiante est√° solvente, no seleccione ning√∫n mes.</p>
            </div>
            <div class="form-group"><label>Monto de Mensualidad ($)</label><input type="number" id="inMon" value="0"></div>
            <button class="btn-action" onclick="guardarTodo()">REGISTRAR Y ARCHIVAR</button>
        </div>
    </section>

    <section id="mod-arch" class="modulo">
        <div id="v-niveles">
            <h3>Archivador de Niveles</h3>
            <div class="folder-grid">
                <div class="folder" onclick="vGrados('INICIAL')"><span class="folder-icon">üìÇ</span><b>EDUC. INICIAL</b></div>
                <div class="folder" onclick="vGrados('PRIMARIA')"><span class="folder-icon">üìÇ</span><b>PRIMARIA</b></div>
                <div class="folder" onclick="vGrados('BACHILLERATO')"><span class="folder-icon">üìÇ</span><b>BACHILLERATO</b></div>
            </div>
        </div>
        <div id="v-grados" style="display:none">
            <button onclick="backN()" style="margin-bottom:15px">‚¨Ö Volver a Niveles</button>
            <h3 id="titNivel" style="margin-bottom:15px"></h3>
            <div class="folder-grid" id="boxGrados"></div>
        </div>
        <div id="v-secciones" style="display:none">
            <button onclick="backG()" style="margin-bottom:15px">‚¨Ö Volver a Grados</button>
            <h3 id="titGrado" style="margin-bottom:15px"></h3>
            <div class="folder-grid">
                <div class="folder" onclick="vFinal('A')"><span class="folder-icon">üìÅ</span><b>SECCI√ìN A</b></div>
                <div class="folder" onclick="vFinal('B')"><span class="folder-icon">üìÅ</span><b>SECCI√ìN B</b></div>
            </div>
        </div>
        <div id="v-final" style="display:none">
            <button onclick="backS()" style="margin-bottom:15px">‚¨Ö Volver</button>
            <h3 id="titFinal"></h3>
            <div id="boxAlu" style="margin-top:20px"></div>
        </div>
    </section>

    <section id="mod-pend" class="modulo"><div class="card"><h3>Lista de Alumnos con Deuda</h3><div id="listP"></div></div></section>

    <section id="mod-solv" class="modulo"><div class="card"><h3>Lista de Alumnos Solventes</h3><div id="listS"></div></div></section>

    <section id="mod-valid" class="modulo">
        <div class="card">
            <h3>Pagos por Validar (Banco)</h3>
            <div class="table-container">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Estudiante / Representante</th>
                            <th>Banco</th>
                            <th>Referencia</th>
                            <th>Fecha de Pago</th>
                            <th>Monto Bs / $</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="listR"></tbody>
                </table>
            </div>
        </div>
    </section>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_m1k2Vlu5QTokgjNZ6czlI2XH1YTC3U8",
        authDomain: "reportedepagos-d8485.firebaseapp.com",
        projectId: "reportedepagos-d8485",
        storageBucket: "reportedepagos-d8485.appspot.com",
        messagingSenderId: "335664812002",
        appId: "1:335664812002:web:609ecb3008145281af3bb8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COLECCION = "db_sdj_final_completa";

    let gSeleccionado = "";

    window.tab = (t) => {
        document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mod-'+t).classList.add('active');
        event.currentTarget.classList.add('active');
    };

    window.guardarTodo = async () => {
        const ms = Array.from(document.getElementById('inMes').selectedOptions).map(o => o.value);
        const monto = parseFloat(document.getElementById('inMon').value) || 0;
        const data = {
            nombre: document.getElementById('inNom').value,
            representante: document.getElementById('inRep').value,
            correo: document.getElementById('inMail').value,
            grado: document.getElementById('inGra').value,
            seccion: document.getElementById('inSec').value,
            meses: ms,
            totalDeuda: ms.length * monto
        };
        if(!data.nombre) return alert("Ingrese el nombre");
        await addDoc(collection(db, COLECCION), data);
        alert("¬°Estudiante registrado con √©xito!");
        location.reload();
    };

    const estructura = {
        'INICIAL': ['Maternal', 'Preescolar 1', 'Preescolar 2', 'Preescolar 3'],
        'PRIMARIA': ['1er Grado','2do Grado','3er Grado','4to Grado','5to Grado','6to Grado'],
        'BACHILLERATO': ['1er A√±o','2do A√±o','3er A√±o','4to A√±o','5to A√±o']
    };

    window.vGrados = (niv) => {
        document.getElementById('v-niveles').style.display='none';
        document.getElementById('v-grados').style.display='block';
        document.getElementById('titNivel').innerText = niv;
        const box = document.getElementById('boxGrados'); box.innerHTML = "";
        estructura[niv].forEach(g => { box.innerHTML += `<div class="folder" onclick="vSecs('${g}')"><span class="folder-icon">üìÅ</span><b>${g}</b></div>`; });
    };

    window.vSecs = (g) => { gSeleccionado = g; document.getElementById('v-grados').style.display='none'; document.getElementById('v-secciones').style.display='block'; document.getElementById('titGrado').innerText = g; };

    window.vFinal = (s) => {
        document.getElementById('v-secciones').style.display='none';
        document.getElementById('v-final').style.display='block';
        document.getElementById('titFinal').innerText = `${gSeleccionado} - Secci√≥n ${s}`;
        onSnapshot(collection(db, COLECCION), (snap) => {
            const box = document.getElementById('boxAlu'); box.innerHTML = "";
            snap.forEach(d => { if(d.data().grado === gSeleccionado && d.data().seccion === s) box.innerHTML += renderEstudiante(d.data(), d.id); });
        });
    };

    onSnapshot(collection(db, COLECCION), (snap) => {
        const lp = document.getElementById('listP'); const ls = document.getElementById('listS');
        lp.innerHTML = ""; ls.innerHTML = "";
        snap.forEach(d => {
            const a = d.data();
            if(a.meses && a.meses.length > 0) lp.innerHTML += renderEstudiante(a, d.id);
            else ls.innerHTML += renderEstudiante(a, d.id);
        });
    });

    onSnapshot(collection(db, "pagos_reportados"), (snap) => {
        const box = document.getElementById('listR'); box.innerHTML = "";
        snap.forEach(d => {
            const r = d.data();
            box.innerHTML += `
                <tr>
                    <td><b>${r.nombreEst}</b><br><small>Rep: ${r.nombreRep || 'N/A'}</small></td>
                    <td><span class="bank-tag">${r.banco || 'BANCO'}</span></td>
                    <td><code>${r.referencia || '---'}</code></td>
                    <td>${r.fecha || 'Hoy'}</td>
                    <td><span class="price-bs">Bs ${r.montoBs || '0'}</span><br><span class="price-dl">$${r.montoDivisas || r.monto || '0'}</span></td>
                    <td><button onclick="delDoc('pagos_reportados','${d.id}')" style="background:var(--success); color:white; border:none; padding:8px; border-radius:5px; cursor:pointer">‚úÖ OK</button></td>
                </tr>`;
        });
    });

    function renderEstudiante(a, id) {
        const deudor = a.meses && a.meses.length > 0;
        return `
            <div class="student-item ${deudor ? 'debtor' : ''}">
                <div>
                    <b>${a.nombre}</b><br><small>Rep: ${a.representante}</small><br>
                    ${a.meses ? a.meses.map(m => `<span class="tag-mes">${m}</span>`).join('') : ''}
                </div>
                <div style="text-align:right">
                    ${deudor ? `<b style="color:red; font-size:18px">$${a.totalDeuda}</b><br><button onclick="enviarMail('${a.correo}','${a.nombre}','${a.meses.join(',')}','${a.totalDeuda}')" style="background:#f59e0b; border:none; color:white; padding:8px; border-radius:5px; cursor:pointer; margin-top:5px">‚úâÔ∏è Notificar</button>` : '<b style="color:green">SOLVENTE</b>'}
                    <br><button onclick="delDoc('${COLECCION}','${id}')" style="color:red; border:none; background:none; font-size:10px; cursor:pointer; margin-top:10px">Borrar Registro</button>
                </div>
            </div>`;
    }

    window.enviarMail = (c,n,m,t) => window.location.href=`mailto:${c}?subject=Recordatorio SDJ&body=El estudiante ${n} presenta deuda en: ${m}. Total: $${t}`;
    window.delDoc = async (col, id) => { if(confirm("¬øSeguro de realizar esta acci√≥n?")) await deleteDoc(doc(db, col, id)); };
    window.backN = () => { document.getElementById('v-grados').style.display='none'; document.getElementById('v-niveles').style.display='block'; };
    window.backG = () => { document.getElementById('v-secciones').style.display='none'; document.getElementById('v-grados').style.display='block'; };
    window.backS = () => { document.getElementById('v-final').style.display='none'; document.getElementById('v-secciones').style.display='block'; };

</script>
</body>
</html>
