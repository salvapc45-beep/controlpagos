<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA SDJ - CONTROL V14.1</title>
    <style>
        :root {
            --primary: #1e3a8a; --bg: #f8fafc; --text: #0f172a;
            --green: #22c55e; --yellow: #eab308; --red: #ef4444;
            --whatsapp: #25D366;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }

        header { background: var(--primary); color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        /* NAV */
        nav { display: flex; background: white; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid #e2e8f0; overflow-x: auto; }
        .nav-btn { flex: 1; min-width: 100px; padding: 15px 5px; text-align: center; cursor: pointer; font-weight: bold; font-size: 11px; color: #64748b; text-transform: uppercase; border-bottom: 4px solid transparent; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #f1f5f9; }

        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        .modulo { display: none; }
        .modulo.active { display: block; animation: fadeIn 0.4s; }

        /* CARDS & FORMS */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-top: 8px; font-size: 14px; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        
        /* ALERTAS & PENDIENTES */
        .btn-alert-all { background: #4f46e5; color: white; width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }

        .grado-header { background: #1e293b; color: white; padding: 10px 15px; border-radius: 6px; font-weight: bold; text-transform: uppercase; font-size: 13px; margin: 25px 0 10px 0; letter-spacing: 0.5px; }

        .student-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 8px; position: relative; }
        
        /* BORDES DE ALERTA */
        .alert-previa { border-left: 6px solid var(--green); }
        .alert-normal { border-left: 6px solid var(--yellow); }
        .alert-urgente { border-left: 6px solid var(--red); }

        /* BADGES (ETIQUETAS) */
        .badge { font-size: 9px; padding: 3px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; display: inline-block; margin-bottom: 4px; }
        .bg-previa { background: #dcfce7; color: #15803d; }
        .bg-normal { background: #fef9c3; color: #a16207; }
        .bg-urgente { background: #fee2e2; color: #b91c1c; }

        .info b { display: block; font-size: 15px; color: var(--primary); }
        .info small { color: #64748b; font-size: 12px; display: block; }
        .tag-mes { display: inline-block; background: #f1f5f9; border: 1px solid #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin: 4px 2px 0 0; color: #475569; }

        /* ARCHIVOS */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 15px; }
        .folder { background: white; border: 1px solid #e2e8f0; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .folder:hover { background: #f8fafc; border-color: var(--primary); }
        .icon { font-size: 30px; display: block; margin-bottom: 5px; }

        /* TABLA REPORTES */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; font-size: 12px; }
        th { background: #f1f5f9; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .btn-check { background: var(--green); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-right: 5px; font-weight: bold; }
        .btn-reject { background: var(--red); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .btn-ws { border:none; background:transparent; font-size:22px; cursor:pointer; color: var(--whatsapp); margin-right: 10px; }
        .btn-print { background: #64748b; color: white; border:none; padding: 8px 15px; border-radius: 5px; cursor: pointer; float: right; font-size: 12px;}

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ESTILOS DE IMPRESI√ìN */
        @media print {
            nav, header, .btn-print, button, input { display: none !important; }
            body, .container, .modulo { background: white; margin: 0; padding: 0; }
            .student-row { border: 1px solid #000; break-inside: avoid; }
            #mod-arch, #view-list, #final-list { display: block !important; }
        }
    </style>
</head>
<body>

<header>SISTEMA ADMINISTRATIVO SDJ (V14)</header>

<nav>
    <div class="nav-btn active" onclick="go('reg')">1. Registro</div>
    <div class="nav-btn" onclick="go('arch')">2. Archivos</div>
    <div class="nav-btn" onclick="go('pend')">3. Pendientes</div>
    <div class="nav-btn" onclick="go('solv')">4. Solventes</div>
    <div class="nav-btn" onclick="go('rep')">5. Reportes</div>
</nav>

<div class="container">

    <section id="mod-reg" class="modulo active">
        <div class="card">
            <h3>Registrar Alumno / Deuda</h3>
            <p style="font-size:12px; color:gray; margin-bottom:10px">* Nuevo: Agregue tel√©fono para usar WhatsApp.</p>
            
            <input type="text" id="rNom" placeholder="Nombre del Alumno">
            <input type="text" id="rRep" placeholder="Nombre del Representante">
            <input type="email" id="rMail" placeholder="Correo (Opcional)">
            <input type="tel" id="rTel" placeholder="Tel√©fono (Ej: 584120000000)">
            
            <div style="display:flex; gap:10px">
                <select id="rGra">
                    <option>5to A√±o</option><option>4to A√±o</option><option>3er A√±o</option><option>2do A√±o</option><option>1er A√±o</option>
                    <option>6to Grado</option><option>5to Grado</option><option>4to Grado</option><option>3er Grado</option><option>2do Grado</option><option>1er Grado</option>
                    <option>Preescolar 3</option><option>Preescolar 2</option><option>Preescolar 1</option><option>Maternal</option>
                </select>
                <select id="rSec" style="width:100px"><option>A</option><option>B</option></select>
            </div>

            <label style="font-size:12px; font-weight:bold; margin-top:10px; display:block">Meses Pendientes:</label>
            <select id="rMes" multiple style="height:120px">
                <option value="Inscripci√≥n">Inscripci√≥n</option>
                <option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                <option value="Enero">Enero</option><option value="Febrero">Febrero</option><option value="Marzo">Marzo</option><option value="Abril">Abril</option>
                <option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option>
            </select>
            
            <input type="number" id="rMon" placeholder="Monto Mensual ($)">
            <button class="btn-main" onclick="guardar()">GUARDAR REGISTRO</button>
        </div>
    </section>

    <section id="mod-arch" class="modulo">
        <div id="view-level">
            <h3>Explorador de Archivos</h3>
            <div class="card" style="background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; margin-top:10px; text-align: center;">
                <small>DEUDA TOTAL DEL COLEGIO</small>
                <h2 id="global-debt" style="font-size: 28px;">Calculando...</h2>
            </div>

            <div class="folder-grid">
                <div class="folder" onclick="loadLevel('INICIAL')"><span class="icon">üìÇ</span>INICIAL</div>
                <div class="folder" onclick="loadLevel('PRIMARIA')"><span class="icon">üìÇ</span>PRIMARIA</div>
                <div class="folder" onclick="loadLevel('BACHILLERATO')"><span class="icon">üìÇ</span>BACHILLERATO</div>
            </div>
        </div>
        
        <div id="view-grade" style="display:none">
            <button onclick="resetArch()" style="margin-bottom:10px">‚¨Ö Atr√°s</button>
            <h3 id="tit-grade"></h3>
            <div id="grid-grade" class="folder-grid"></div>
        </div>
        
        <div id="view-sec" style="display:none">
            <button onclick="backToGrade()" style="margin-bottom:10px">‚¨Ö Atr√°s</button>
            <h3 id="tit-sec"></h3>
            <div class="folder-grid">
                <div class="folder" onclick="loadFinal('A')"><span class="icon">üìÅ</span>Secci√≥n A</div>
                <div class="folder" onclick="loadFinal('B')"><span class="icon">üìÅ</span>Secci√≥n B</div>
            </div>
        </div>
        
        <div id="view-list" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="backToSec()" style="margin-bottom:10px">‚¨Ö Atr√°s</button>
                <button class="btn-print" onclick="window.print()">üñ® Imprimir Lista</button>
            </div>
            
            <h3 id="tit-list"></h3>
            
            <div class="card" style="background:#fff7ed; border-color:#fed7aa; margin-top:10px; padding:15px;">
                <div style="text-align:right; margin-bottom:10px;">
                    <span id="sec-total-label" style="font-size:13px; color:#9a3412; font-weight:bold;">CALCULANDO DEUDA...</span>
                </div>
                <input type="text" id="search-filter" placeholder="üîç Buscar estudiante en esta secci√≥n..." onkeyup="filterList()" style="margin-top:0;">
            </div>

            <div class="card" style="margin-top:15px">
                <div id="final-list"></div>
            </div>
        </div>
    </section>

    <section id="mod-pend" class="modulo">
        <button class="btn-alert-all" onclick="notifyAll()">
            üì¢ ENVIAR RECORDATORIOS (Email)
        </button>
        <div class="card">
            <div id="list-pend">Cargando deudores...</div>
        </div>
    </section>

    <section id="mod-solv" class="modulo">
        <div class="card"><h3>Estudiantes al D√≠a</h3><div id="list-solv"></div></div>
    </section>

    <section id="mod-rep" class="modulo">
        <div class="card">
            <h3>Pagos Reportados (Banco)</h3>
            <p style="font-size:12px; color:gray; margin-bottom:10px">Valide si el dinero est√° en cuenta o Rechace si hay error.</p>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Alumno / Rep</th><th>Ref / Banco</th><th>Monto</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="table-rep"></tbody>
                </table>
            </div>
        </div>
    </section>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_m1k2Vlu5QTokgjNZ6czlI2XH1YTC3U8",
        authDomain: "reportedepagos-d8485.firebaseapp.com",
        projectId: "reportedepagos-d8485",
        storageBucket: "reportedepagos-d8485.appspot.com",
        messagingSenderId: "335664812002",
        appId: "1:335664812002:web:609ecb3008145281af3bb8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    const DB_MAIN = "sdj_final_v11"; 
    const DB_PAGOS = "pagos_reportados";

    const ORDEN_GRADOS = [
        "5to A√±o", "4to A√±o", "3er A√±o", "2do A√±o", "1er A√±o",
        "6to Grado", "5to Grado", "4to Grado", "3er Grado", "2do Grado", "1er Grado",
        "Preescolar 3", "Preescolar 2", "Preescolar 1", "Maternal"
    ];

    window.go = (id) => {
        document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mod-'+id).classList.add('active');
        event.currentTarget.classList.add('active');
    };

    window.guardar = async () => {
        const ms = Array.from(document.getElementById('rMes').selectedOptions).map(o => o.value);
        const mon = parseFloat(document.getElementById('rMon').value) || 0;
        
        await addDoc(collection(db, DB_MAIN), {
            nombre: document.getElementById('rNom').value,
            rep: document.getElementById('rRep').value,
            mail: document.getElementById('rMail').value,
            tel: document.getElementById('rTel').value, // NUEVO CAMPO
            grado: document.getElementById('rGra').value,
            seccion: document.getElementById('rSec').value,
            meses: ms,
            total: ms.length * mon,
            timestamp: new Date()
        });
        alert("¬°Registro Exitoso!"); location.reload();
    };

    let cachePendientes = [];

    // SNAPSHOT PRINCIPAL
    onSnapshot(collection(db, DB_MAIN), (snap) => {
        const lp = document.getElementById('list-pend');
        const ls = document.getElementById('list-solv');
        const globalDebt = document.getElementById('global-debt');
        
        lp.innerHTML = ""; ls.innerHTML = "";
        cachePendientes = [];
        let totalColegio = 0;

        let allData = [];
        snap.forEach(d => allData.push({ ...d.data(), id: d.id }));

        // PENDIENTES
        ORDEN_GRADOS.forEach(grado => {
            const grupo = allData.filter(x => x.grado === grado && x.meses.length > 0);
            if(grupo.length > 0) {
                lp.innerHTML += `<div class="grado-header">${grado}</div>`;
                grupo.forEach(a => {
                    const alerta = getNivelAlerta(a.meses.length);
                    cachePendientes.push({ ...a, tipoAlerta: alerta.tipo });
                    totalColegio += (parseFloat(a.total) || 0);

                    // LOGICA WHATSAPP
                    let wsBtn = "";
                    if(a.tel) {
                        const msg = `Hola Sr(a) ${a.rep}, le escribimos del colegio para recordarle el pago pendiente del alumno ${a.nombre}. Monto: $${a.total}`;
                        wsBtn = `<button class="btn-ws" onclick="window.open('https://wa.me/${a.tel}?text=${encodeURIComponent(msg)}', '_blank')">üì±</button>`;
                    }

                    lp.innerHTML += `
                        <div class="student-row alert-${alerta.clase}">
                            <div class="info">
                                <span class="badge bg-${alerta.clase}">${alerta.texto}</span>
                                <b>${a.nombre} (${a.seccion})</b>
                                <small>${a.rep}</small>
                                <div>${a.meses.map(m => `<span class="tag-mes">${m}</span>`).join('')}</div>
                            </div>
                            <div style="text-align:right">
                                <b style="color:#ef4444">$${a.total}</b><br>
                                <div style="margin-top:5px">
                                    ${wsBtn}
                                    <button onclick="sendMail('${a.mail}', '${a.nombre}', '${alerta.tipo}')" style="border:none; background:transparent; font-size:20px; cursor:pointer">‚úâÔ∏è</button>
                                </div>
                                <button onclick="del('${a.id}')" style="font-size:10px; color:gray; border:none; background:none; cursor:pointer; margin-top:5px">Eliminar</button>
                            </div>
                        </div>`;
                });
            }
        });

        // SOLVENTES
        allData.filter(x => x.meses.length === 0).forEach(a => {
            ls.innerHTML += `<div class="student-row" style="border-left:5px solid var(--green)"><div class="info"><b>${a.nombre}</b><small>${a.grado} (${a.seccion})</small></div><b style="color:var(--green)">SOLVENTE</b></div>`;
        });

        // ACTUALIZAR DEUDA GLOBAL
        if(globalDebt) globalDebt.innerText = `$${totalColegio.toLocaleString()}`;
    });

    function getNivelAlerta(meses) {
        const dia = new Date().getDate();
        if (meses >= 3 || (meses >= 1 && dia > 10)) {
            return { texto: "ALERTA URGENTE", clase: "urgente", tipo: "urgente" };
        } else if (meses === 2) {
            return { texto: "ALERTA NORMAL", clase: "normal", tipo: "normal" };
        } else {
            return { texto: "ALERTA PREVIA", clase: "previa", tipo: "previa" };
        }
    }

    window.sendMail = (mail, nom, tipo) => {
        const msgs = {
            previa: `Estimado representante, le recordamos el pago mensual del alumno ${nom}.`,
            normal: `Estimado representante, el alumno ${nom} tiene 2 meses pendientes. Favor regularizar.`,
            urgente: `URGENTE: El alumno ${nom} presenta deuda cr√≠tica o vencimiento de plazo. Favor contactar administraci√≥n.`
        };
        window.location.href = `mailto:${mail}?subject=Aviso de Cobro SDJ&body=${msgs[tipo]}`;
    };

    window.notifyAll = () => {
        if(confirm(`Enviar correos a ${cachePendientes.length} representantes?`)) {
            cachePendientes.forEach((a, i) => { setTimeout(() => sendMail(a.mail, a.nombre, a.tipoAlerta), i * 800); });
        }
    };

    // --- ARCHIVOS Y NAVEGACION ---
    let curLvl = "", curGra = "";
    const struct = {
        'INICIAL': ['Maternal', 'Preescolar 1', 'Preescolar 2', 'Preescolar 3'],
        'PRIMARIA': ['1er Grado','2do Grado','3er Grado','4to Grado','5to Grado','6to Grado'],
        'BACHILLERATO': ['1er A√±o','2do A√±o','3er A√±o','4to A√±o','5to A√±o']
    };

    window.loadLevel = (l) => {
        curLvl = l;
        document.getElementById('view-level').style.display='none';
        document.getElementById('view-grade').style.display='block';
        document.getElementById('tit-grade').innerText = l;
        const grid = document.getElementById('grid-grade'); grid.innerHTML = "";
        struct[l].forEach(g => grid.innerHTML += `<div class="folder" onclick="loadSec('${g}')">üìÅ<br>${g}</div>`);
    };
    window.loadSec = (g) => { curGra = g; document.getElementById('view-grade').style.display='none'; document.getElementById('view-sec').style.display='block'; document.getElementById('tit-sec').innerText = g; };
    
    // CARGAR LISTA FINAL
    window.loadFinal = (s) => {
        document.getElementById('view-sec').style.display='none';
        document.getElementById('view-list').style.display='block';
        document.getElementById('tit-list').innerText = `${curGra} - SECCI√ìN ${s}`;
        document.getElementById('search-filter').value = ""; // Limpiar buscador
        
        document.getElementById('final-list').innerHTML = "Cargando...";
        document.getElementById('sec-total-label').innerHTML = "Calculando...";

        onSnapshot(collection(db, DB_MAIN), (snap) => {
            const div = document.getElementById('final-list'); 
            const labelTotal = document.getElementById('sec-total-label');
            div.innerHTML = "";
            
            let count = 0;
            let deudaAcumulada = 0;

            snap.forEach(d => {
                const a = d.data();
                if(a.grado === curGra && a.seccion === s) {
                    count++;
                    
                    let esSolvente = (a.meses.length === 0);
                    let borde = esSolvente ? "border-left: 6px solid var(--green)" : "border-left: 6px solid var(--red)";
                    let status = esSolvente ? `<b style="color:var(--green)">SOLVENTE</b>` : `<b style="color:var(--red)">DEUDA</b><br><span style="font-size:11px; color:#ef4444">$${a.total}</span>`;
                    
                    if(!esSolvente) deudaAcumulada += (parseFloat(a.total) || 0);

                    // Agregamos data-name para el buscador
                    div.innerHTML += `
                    <div class="student-row item-lista" data-name="${a.nombre.toLowerCase()}" style="${borde}">
                        <div class="info"><b>${a.nombre}</b><small>${a.rep}</small></div>
                        <div style="text-align:right">${status}</div>
                    </div>`;
                }
            });

            if(deudaAcumulada > 0) {
                labelTotal.innerHTML = `TOTAL PENDIENTE SECCI√ìN: <span style="font-size:16px; color:#ef4444">$${deudaAcumulada}</span>`;
            } else {
                labelTotal.innerHTML = `<span style="color:var(--green)">SECCI√ìN SOLVENTE ($0)</span>`;
            }

            if(count === 0) div.innerHTML = "<p style='text-align:center; padding:20px; color:gray'>Carpeta Vac√≠a</p>";
        });
    };

    // FUNCION DE FILTRADO (BUSCADOR)
    window.filterList = () => {
        const term = document.getElementById('search-filter').value.toLowerCase();
        const items = document.querySelectorAll('.item-lista');
        items.forEach(item => {
            const name = item.getAttribute('data-name');
            item.style.display = name.includes(term) ? "flex" : "none";
        });
    };
    
    window.resetArch = () => { document.getElementById('view-grade').style.display='none'; document.getElementById('view-level').style.display='block'; };
    window.backToGrade = () => { document.getElementById('view-sec').style.display='none'; document.getElementById('view-grade').style.display='block'; };
    window.backToSec = () => { document.getElementById('view-list').style.display='none'; document.getElementById('view-sec').style.display='block'; };

    // --- REPORTES ---
    onSnapshot(collection(db, DB_PAGOS), (snap) => {
        const tb = document.getElementById('table-rep'); tb.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            tb.innerHTML += `<tr>
                <td>${p.nombreEst}<br><small>${p.nombreRep || '-'}</small></td>
                <td><b>${p.banco || 'BANCO'}</b><br>${p.referencia || 'REF'}</td>
                <td>Bs.${p.montoBs || 0}<br>$${p.montoDivisas || p.monto || 0}</td>
                <td>
                    <button class="btn-check" onclick="validar('${d.id}')">‚úî</button>
                    <button class="btn-reject" onclick="rechazar('${d.id}','${p.referencia}')">‚úñ</button>
                </td>
            </tr>`;
        });
    });

    window.del = async(id) => { if(confirm("¬øEliminar Alumno?")) await deleteDoc(doc(db, DB_MAIN, id)); };
    window.validar = async(id) => { if(confirm("¬øPago VERIFICADO?")) await deleteDoc(doc(db, DB_PAGOS, id)); };
    
    window.rechazar = async(id, ref) => {
        if(confirm("¬øReportar como NO VERIFICADO?")) {
            window.location.href = `mailto:?subject=Error Pago SDJ&body=Ref ${ref} no verificada.`;
            await deleteDoc(doc(db, DB_PAGOS, id));
        }
    };

</script>
</body>
</html>

