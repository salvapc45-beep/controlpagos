<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA INTEGRAL SDJ - V13 FINAL</title>
    <style>
        :root {
            --primary: #1e3a8a; --bg: #f8fafc; --text: #0f172a;
            --green: #22c55e; --yellow: #eab308; --red: #ef4444;
            --dark: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }

        header { background: var(--primary); color: white; padding: 25px; text-align: center; font-weight: bold; font-size: 1.4rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* NAVEGACI√ìN */
        nav { display: flex; background: white; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid #e2e8f0; overflow-x: auto; }
        .nav-btn { flex: 1; min-width: 100px; padding: 18px 5px; text-align: center; cursor: pointer; font-weight: bold; font-size: 11px; color: #64748b; text-transform: uppercase; border-bottom: 4px solid transparent; transition: 0.3s; }
        .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #f1f5f9; }

        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        .modulo { display: none; }
        .modulo.active { display: block; animation: fadeIn 0.4s; }

        /* CARDS */
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        input, select { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 10px; margin-top: 10px; font-size: 15px; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 16px; border: none; border-radius: 10px; font-weight: bold; margin-top: 20px; cursor: pointer; font-size: 16px; }
        
        /* PENDIENTES Y ALERTAS */
        .grado-header { background: var(--dark); color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; text-transform: uppercase; font-size: 14px; margin: 30px 0 12px 0; letter-spacing: 1px; }
        .student-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 18px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 10px; transition: 0.2s; cursor: pointer; }
        .student-row:hover { transform: scale(1.01); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        .alert-previa { border-left: 8px solid var(--green); }
        .alert-normal { border-left: 8px solid var(--yellow); }
        .alert-urgente { border-left: 8px solid var(--red); }

        /* MODAL DE FICHA DEL ALUMNO */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-width: 450px; padding: 30px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        .modal-content h2 { color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; }
        .info-block { margin-bottom: 15px; }
        .info-label { font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; }
        .info-value { font-size: 16px; color: var(--dark); font-weight: 500; }

        /* ARCHIVOS */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 20px; }
        .folder { background: white; border: 1px solid #e2e8f0; padding: 30px 15px; text-align: center; border-radius: 15px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .folder:hover { border-color: var(--primary); background: #f8fafc; color: var(--primary); }
        
        /* REPORTES TABLA */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th { background: #f1f5f9; padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        .btn-act { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; margin-right: 5px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>SISTEMA ADMINISTRATIVO SDJ (V13)</header>

<nav>
    <div class="nav-btn active" onclick="go('reg')">1. Registro</div>
    <div class="nav-btn" onclick="go('arch')">2. Archivos</div>
    <div class="nav-btn" onclick="go('pend')">3. Pendientes</div>
    <div class="nav-btn" onclick="go('solv')">4. Solventes</div>
    <div class="nav-btn" onclick="go('rep')">5. Reportes</div>
</nav>

<div id="studentModal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2>Ficha del Alumno</h2>
        <div id="modalData"></div>
        <button class="btn-main" onclick="closeModal()">CERRAR EXPEDIENTE</button>
    </div>
</div>

<div class="container">

    <section id="mod-reg" class="modulo active">
        <div class="card">
            <h3>Nuevo Registro de Estudiante</h3>
            <input type="text" id="rNom" placeholder="Nombre y Apellido del Estudiante">
            <input type="text" id="rRep" placeholder="Nombre del Representante">
            <input type="email" id="rMail" placeholder="Correo Electr√≥nico (Para notificaciones)">
            <div style="display:flex; gap:10px">
                <select id="rGra">
                    <option>5to A√±o</option><option>4to A√±o</option><option>3er A√±o</option><option>2do A√±o</option><option>1er A√±o</option>
                    <option>6to Grado</option><option>5to Grado</option><option>4to Grado</option><option>3er Grado</option><option>2do Grado</option><option>1er Grado</option>
                    <option>Preescolar 3</option><option>Preescolar 2</option><option>Preescolar 1</option><option>Maternal</option>
                </select>
                <select id="rSec" style="width:100px"><option>A</option><option>B</option></select>
            </div>
            <label style="display:block; margin-top:15px; font-weight:bold; font-size:12px">MESES PENDIENTES (Presione Ctrl o Cmd para seleccionar varios):</label>
            <select id="rMes" multiple style="height:150px">
                <option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                <option value="Enero">Enero</option><option value="Febrero">Febrero</option><option value="Marzo">Marzo</option><option value="Abril">Abril</option>
                <option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option>
            </select>
            <input type="number" id="rMon" placeholder="Monto Mensual en $">
            <button class="btn-main" onclick="guardarAlumno()">REGISTRAR EN BASE DE DATOS</button>
        </div>
    </section>

    <section id="mod-arch" class="modulo">
        <div id="arch-lvl">
            <h3>Carpetas por Nivel</h3>
            <div class="folder-grid">
                <div class="folder" onclick="openLvl('INICIAL')">üìÇ INICIAL</div>
                <div class="folder" onclick="openLvl('PRIMARIA')">üìÇ PRIMARIA</div>
                <div class="folder" onclick="openLvl('BACHILLERATO')">üìÇ BACHILLERATO</div>
            </div>
        </div>
        <div id="arch-gra" style="display:none">
            <button onclick="backToLvl()" style="margin-bottom:10px">‚¨Ö Volver</button>
            <h3 id="h-gra"></h3>
            <div id="g-gra" class="folder-grid"></div>
        </div>
        <div id="arch-sec" style="display:none">
            <button onclick="backToGra()" style="margin-bottom:10px">‚¨Ö Volver</button>
            <h3 id="h-sec"></h3>
            <div class="folder-grid">
                <div class="folder" onclick="openFinal('A')">üìÅ SECCI√ìN A</div>
                <div class="folder" onclick="openFinal('B')">üìÅ SECCI√ìN B</div>
            </div>
        </div>
        <div id="arch-list" style="display:none">
            <button onclick="backToSec()" style="margin-bottom:10px">‚¨Ö Volver</button>
            <h3 id="h-list"></h3>
            <div id="listado-final" style="margin-top:20px"></div>
        </div>
    </section>

    <section id="mod-pend" class="modulo">
        <div id="render-pend">Cargando lista de deudores...</div>
    </section>

    <section id="mod-solv" class="modulo">
        <div class="card">
            <h3>Alumnos Solventes</h3>
            <div id="render-solv"></div>
        </div>
    </section>

    <section id="mod-rep" class="modulo">
        <div class="card">
            <h3>Validaci√≥n de Pagos Reportados</h3>
            <div style="overflow-x:auto">
                <table>
                    <thead><tr><th>Alumno</th><th>Referencia</th><th>Monto</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="table-pagos"></tbody>
                </table>
            </div>
        </div>
    </section>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_m1k2Vlu5QTokgjNZ6czlI2XH1YTC3U8",
        authDomain: "reportedepagos-d8485.firebaseapp.com",
        projectId: "reportedepagos-d8485",
        storageBucket: "reportedepagos-d8485.appspot.com",
        messagingSenderId: "335664812002",
        appId: "1:335664812002:web:609ecb3008145281af3bb8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COL_EST = "sdj_v13_estudiantes";
    const COL_PAG = "pagos_reportados";

    const ORDEN = ["5to A√±o", "4to A√±o", "3er A√±o", "2do A√±o", "1er A√±o", "6to Grado", "5to Grado", "4to Grado", "3er Grado", "2do Grado", "1er Grado", "Preescolar 3", "Preescolar 2", "Preescolar 1", "Maternal"];

    window.go = (id) => {
        document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mod-'+id).classList.add('active');
        event.currentTarget.classList.add('active');
    };

    // REGISTRO
    window.guardarAlumno = async () => {
        const meses = Array.from(document.getElementById('rMes').selectedOptions).map(o => o.value);
        const monto = parseFloat(document.getElementById('rMon').value) || 0;
        await addDoc(collection(db, COL_EST), {
            nombre: document.getElementById('rNom').value,
            rep: document.getElementById('rRep').value,
            mail: document.getElementById('rMail').value,
            grado: document.getElementById('rGra').value,
            seccion: document.getElementById('rSec').value,
            meses: meses,
            total: meses.length * monto
        });
        alert("¬°Alumno registrado con √©xito!");
        location.reload();
    };

    // MOTOR DE PENDIENTES
    onSnapshot(collection(db, COL_EST), (snap) => {
        const rp = document.getElementById('render-pend');
        const rs = document.getElementById('render-solv');
        rp.innerHTML = ""; rs.innerHTML = "";
        let data = [];
        snap.forEach(d => data.push({...d.data(), id: d.id}));

        ORDEN.forEach(g => {
            const grupo = data.filter(a => a.grado === g && a.meses.length > 0);
            if(grupo.length > 0) {
                rp.innerHTML += `<div class="grado-header">${g}</div>`;
                grupo.forEach(a => {
                    const alerta = getAlerta(a.meses.length);
                    rp.innerHTML += `
                        <div class="student-row alert-${alerta}" onclick="verFicha('${encodeURIComponent(JSON.stringify(a))}')">
                            <div>
                                <b>${a.nombre}</b><br>
                                <small>${a.seccion} | Rep: ${a.rep}</small>
                            </div>
                            <b style="color:var(--red)">$${a.total}</b>
                        </div>`;
                });
            }
        });

        data.filter(a => a.meses.length === 0).forEach(a => {
            rs.innerHTML += `<div class="student-row" style="border-left:8px solid var(--green)"><b>${a.nombre}</b> <span style="color:var(--green)">SOLVENTE</span></div>`;
        });
    });

    function getAlerta(n) {
        const dia = new Date().getDate();
        if(n >= 3 || (n >= 1 && dia > 10)) return "urgente";
        if(n === 2) return "normal";
        return "previa";
    }

    // FICHA DETALLADA
    window.verFicha = (json) => {
        const a = JSON.parse(decodeURIComponent(json));
        document.getElementById('modalData').innerHTML = `
            <div class="info-block"><div class="info-label">Alumno</div><div class="info-value">${a.nombre}</div></div>
            <div class="info-block"><div class="info-label">Representante</div><div class="info-value">${a.rep}</div></div>
            <div class="info-block"><div class="info-label">Correo</div><div class="info-value">${a.mail}</div></div>
            <div class="info-block"><div class="info-label">Grado y Secci√≥n</div><div class="info-value">${a.grado} - ${a.seccion}</div></div>
            <div class="info-block"><div class="info-label">Meses Adeudados</div><div class="info-value">${a.meses.join(", ")}</div></div>
            <div class="info-block"><div class="info-label">Deuda Total</div><div class="info-value" style="color:red; font-size:22px">$${a.total}</div></div>
        `;
        document.getElementById('studentModal').style.display = "flex";
    };
    window.closeModal = () => document.getElementById('studentModal').style.display = "none";

    // ARCHIVOS
    let curL = "", curG = "";
    const niveles = {
        'INICIAL': ['Maternal', 'Preescolar 1', 'Preescolar 2', 'Preescolar 3'],
        'PRIMARIA': ['1er Grado','2do Grado','3er Grado','4to Grado','5to Grado','6to Grado'],
        'BACHILLERATO': ['1er A√±o','2do A√±o','3er A√±o','4to A√±o','5to A√±o']
    };

    window.openLvl = (l) => {
        curL = l; document.getElementById('arch-lvl').style.display='none'; document.getElementById('arch-gra').style.display='block';
        document.getElementById('h-gra').innerText = l;
        const grid = document.getElementById('g-gra'); grid.innerHTML = "";
        niveles[l].forEach(g => grid.innerHTML += `<div class="folder" onclick="openSec('${g}')">üìÅ ${g}</div>`);
    };
    window.openSec = (g) => {
        curG = g; document.getElementById('arch-gra').style.display='none'; document.getElementById('arch-sec').style.display='block';
        document.getElementById('h-sec').innerText = g;
    };
    window.openFinal = (s) => {
        document.getElementById('arch-sec').style.display='none'; document.getElementById('arch-list').style.display='block';
        document.getElementById('h-list').innerText = `${curG} - SECCI√ìN ${s}`;
        onSnapshot(collection(db, COL_EST), (snap) => {
            const list = document.getElementById('listado-final'); list.innerHTML = "";
            snap.forEach(d => {
                const a = d.data();
                if(a.grado === curG && a.seccion === s) {
                    list.innerHTML += `<div class="student-row" onclick="verFicha('${encodeURIComponent(JSON.stringify(a))}')"><b>${a.nombre}</b> <span>‚ÑπÔ∏è</span></div>`;
                }
            });
        });
    };

    window.backToLvl = () => { document.getElementById('arch-gra').style.display='none'; document.getElementById('arch-lvl').style.display='block'; };
    window.backToGra = () => { document.getElementById('arch-sec').style.display='none'; document.getElementById('arch-gra').style.display='block'; };
    window.backToSec = () => { document.getElementById('arch-list').style.display='none'; document.getElementById('arch-sec').style.display='block'; };

    // REPORTES
    onSnapshot(collection(db, COL_PAG), (snap) => {
        const tb = document.getElementById('table-pagos'); tb.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            tb.innerHTML += `<tr>
                <td>${p.nombreEst}</td>
                <td>${p.referencia}</td>
                <td>$${p.monto}</td>
                <td>
                    <button class="btn-act" style="background:var(--green)" onclick="validar('${d.id}')">‚úÖ</button>
                    <button class="btn-act" style="background:var(--red)" onclick="rechazar('${d.id}', '${p.referencia}')">‚ùå</button>
                </td>
            </tr>`;
        });
    });

    window.validar = async (id) => { if(confirm("¬øConfirmar ingreso de dinero?")) await deleteDoc(doc(db, COL_PAG, id)); };
    window.rechazar = async (id, ref) => {
        if(confirm("¬øEl pago es falso o err√≥neo? Se notificar√° al representante.")){
            window.location.href = `mailto:?subject=Pago Rechazado SDJ&body=Su reporte con referencia ${ref} no coincide con nuestro banco.`;
            await deleteDoc(doc(db, COL_PAG, id));
        }
    };

</script>
</body>
</html>
