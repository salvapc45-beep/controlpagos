<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADMINISTRACIÃ“N SDJ - CONTROL TOTAL</title>
    <style>
        :root {
            --azul-oscuro: #1a2a6c;
            --azul-claro: #b21f1f;
            --dorado: #fdbb2d;
            --success: #27ae60;
            --danger: #c0392b;
            --bg: #f0f2f5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: #333; }

        /* HEADER */
        header {
            background: linear-gradient(to right, #1a2a6c, #b21f1f, #fdbb2d);
            color: white; padding: 25px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* NAVEGACIÃ“N PRINCIPAL (APARTADOS SEPARADOS) */
        .menu-principal {
            display: flex; background: white; justify-content: center;
            position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--azul-oscuro);
        }
        .tab-link {
            padding: 18px 25px; cursor: pointer; font-weight: bold; color: #555;
            transition: 0.3s; border-bottom: 4px solid transparent; text-transform: uppercase; font-size: 13px;
        }
        .tab-link.active {
            color: var(--azul-oscuro); border-bottom-color: var(--azul-oscuro); background: #f8f9fa;
        }

        /* CONTENEDOR DE SECCIONES */
        .modulo { display: none; padding: 25px; max-width: 1100px; margin: 0 auto; }
        .modulo.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* FORMULARIOS */
        .card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 700; color: var(--azul-oscuro); font-size: 12px; }
        input, select { width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 10px; outline: none; font-size: 15px; }
        input:focus { border-color: var(--azul-oscuro); }

        .btn-principal {
            background: var(--azul-oscuro); color: white; border: none; padding: 15px 30px;
            border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px;
            font-size: 16px; transition: 0.3s;
        }
        .btn-principal:hover { background: #0d1a4a; transform: scale(1.02); }

        /* APARTADO DE GRADOS (SELECTOR DE CARPETAS) */
        .grid-grados {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px; margin-bottom: 30px;
        }
        .btn-grado {
            background: white; border: 2px solid var(--azul-oscuro); padding: 15px;
            border-radius: 12px; text-align: center; cursor: pointer; font-weight: bold;
            font-size: 12px; transition: 0.3s; color: var(--azul-oscuro);
        }
        .btn-grado.active { background: var(--azul-oscuro); color: white; }

        /* TABLAS PROFESIONALES */
        .tabla-container { background: white; border-radius: 15px; overflow: hidden; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 11px; color: #64748b; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }

        /* ACCIONES */
        .btn-notificar { background: var(--dorado); color: #000; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; margin-right: 5px; }
        .btn-eliminar { background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; }

        .tag-deuda { background: #ffdada; color: #a90000; padding: 4px 8px; border-radius: 5px; font-weight: bold; }
        .tag-mes { background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 5px; font-weight: bold; }

        #alerta { position: fixed; top: 20px; right: 20px; padding: 20px; border-radius: 10px; color: white; display: none; z-index: 2000; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1>SDJ COBROS - SISTEMA DE GESTIÃ“N INTEGRAL</h1>
</header>

<div class="menu-principal">
    <div class="tab-link active" onclick="cambiarSeccion('registro')">1. Registro de Estudiante</div>
    <div class="tab-link" onclick="cambiarSeccion('grados')">2. Archivo por Grados</div>
    <div class="tab-link" onclick="cambiarSeccion('verificacion')">3. Validar Reportes</div>
</div>

<div id="registro" class="modulo active">
    <div class="card">
        <h2 style="margin-bottom: 20px; color: var(--azul-oscuro)">âž• Registrar Alumno y Deuda</h2>
        <div class="grid-inputs">
            <div class="input-group">
                <label>Nombre Completo del Estudiante</label>
                <input type="text" id="regNombre" placeholder="Nombre y Apellido">
            </div>
            <div class="input-group">
                <label>Correo del Representante</label>
                <input type="email" id="regEmail" placeholder="correo@ejemplo.com">
            </div>
            <div class="input-group">
                <label>Grado / AÃ±o</label>
                <select id="regGrado">
                    <option value="">Seleccione...</option>
                    <optgroup label="PREESCOLAR">
                        <option value="Maternal">Maternal</option>
                        <option value="Preescolar 1">Preescolar 1</option>
                        <option value="Preescolar 2">Preescolar 2</option>
                        <option value="Preescolar 3">Preescolar 3</option>
                    </optgroup>
                    <optgroup label="PRIMARIA">
                        <option value="1er Grado">1er Grado</option><option value="2do Grado">2do Grado</option>
                        <option value="3er Grado">3er Grado</option><option value="4to Grado">4to Grado</option>
                        <option value="5to Grado">5to Grado</option><option value="6to Grado">6to Grado</option>
                    </optgroup>
                    <optgroup label="BACHILLERATO">
                        <option value="1er AÃ±o">1er AÃ±o</option><option value="2do AÃ±o">2do AÃ±o</option>
                        <option value="3er AÃ±o">3er AÃ±o</option><option value="4to AÃ±o">4to AÃ±o</option>
                        <option value="5to AÃ±o">5to AÃ±o</option>
                    </optgroup>
                </select>
            </div>
            <div class="input-group">
                <label>Mes de la Deuda</label>
                <select id="regMes">
                    <option value="InscripciÃ³n">InscripciÃ³n</option>
                    <option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option>
                    <option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                    <option value="Enero">Enero</option><option value="Febrero">Febrero</option>
                    <option value="Marzo">Marzo</option><option value="Abril">Abril</option>
                    <option value="Mayo">Mayo</option><option value="Junio">Junio</option>
                    <option value="Julio">Julio</option>
                </select>
            </div>
            <div class="input-group">
                <label>Monto Adeudado ($)</label>
                <input type="number" id="regMonto" placeholder="0.00">
            </div>
        </div>
        <button class="btn-principal" onclick="guardarAlumno()">GUARDAR EN LA BASE DE DATOS</button>
    </div>
</div>

<div id="grados" class="modulo">
    <div class="grid-grados" id="selectorGrados">
        <div class="btn-grado active" onclick="filtrar('Todos')">TODOS</div>
        <div class="btn-grado" onclick="filtrar('Preescolar')">PREESCOLAR</div>
        <div class="btn-grado" onclick="filtrar('Primaria')">PRIMARIA</div>
        <div class="btn-grado" onclick="filtrar('Bachillerato')">BACHILLERATO</div>
    </div>

    <div class="tabla-container">
        <table id="tablaDeudores">
            <thead>
                <tr>
                    <th>Estudiante</th>
                    <th>Grado/AÃ±o</th>
                    <th>Mes</th>
                    <th>Deuda</th>
                    <th>AcciÃ³n</th>
                </tr>
            </thead>
            <tbody id="listaDeudores"></tbody>
        </table>
    </div>
</div>

<div id="verificacion" class="modulo">
    <div class="card">
        <h2 style="margin-bottom: 20px;">âœ… Validar Pagos de Representantes</h2>
        <div class="tabla-container">
            <table>
                <thead>
                    <tr>
                        <th>Estudiante</th>
                        <th>Referencia</th>
                        <th>Monto</th>
                        <th>AcciÃ³n</th>
                    </tr>
                </thead>
                <tbody id="listaPagos"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="alerta"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_m1k2Vlu5QTokgjNZ6czlI2XH1YTC3U8",
        authDomain: "reportedepagos-d8485.firebaseapp.com",
        projectId: "reportedepagos-d8485",
        storageBucket: "reportedepagos-d8485.appspot.com",
        messagingSenderId: "335664812002",
        appId: "1:335664812002:web:609ecb3008145281af3bb8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // NAVEGACIÃ“N ENTRE APARTADOS
    window.cambiarSeccion = (id) => {
        document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    };

    window.mostrarAlerta = (msg, color) => {
        const a = document.getElementById("alerta");
        a.textContent = msg; a.style.background = color;
        a.style.display = "block";
        setTimeout(() => a.style.display = "none", 3000);
    };

    // GUARDAR DATOS
    window.guardarAlumno = async () => {
        const nombre = document.getElementById("regNombre").value;
        const grado = document.getElementById("regGrado").value;
        const monto = document.getElementById("regMonto").value;
        const email = document.getElementById("regEmail").value;
        const mes = document.getElementById("regMes").value;

        if(!nombre || !grado || !monto) return alert("Nombre, Grado y Monto son obligatorios");

        try {
            await addDoc(collection(db, "deudas"), {
                nombre, grado, monto, email, mes,
                fechaRegistro: new Date().toLocaleDateString()
            });
            mostrarAlerta("âœ… Estudiante registrado correctamente", "var(--success)");
            document.querySelectorAll("input").forEach(i => i.value = "");
        } catch(e) { mostrarAlerta("âŒ Error al guardar", "var(--danger)"); }
    };

    // FILTRADO DE GRADOS
    let filtroActual = "Todos";
    window.filtrar = (tipo) => {
        filtroActual = tipo;
        document.querySelectorAll('.btn-grado').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        renderDeudores();
    };

    // RENDERIZAR DEUDORES (LÃ“GICA DE CARPETAS)
    function renderDeudores() {
        onSnapshot(collection(db, "deudas"), (snap) => {
            const tbody = document.getElementById("listaDeudores");
            tbody.innerHTML = "";
            snap.forEach(d => {
                const i = d.data();
                
                // ClasificaciÃ³n automÃ¡tica
                let cat = "";
                if(i.grado.includes("Preescolar") || i.grado === "Maternal") cat = "Preescolar";
                else if(i.grado.includes("Grado")) cat = "Primaria";
                else if(i.grado.includes("AÃ±o")) cat = "Bachillerato";

                if(filtroActual !== "Todos" && cat !== filtroActual) return;

                tbody.innerHTML += `
                    <tr>
                        <td><b>${i.nombre}</b></td>
                        <td>${i.grado}</td>
                        <td><span class="tag-mes">${i.mes}</span></td>
                        <td><span class="tag-deuda">$${i.monto}</span></td>
                        <td>
                            <button class="btn-notificar" onclick="notificar('${i.email}','${i.nombre}','${i.mes}','${i.monto}')">ðŸ”” Notificar</button>
                            <button class="btn-eliminar" onclick="eliminarD('${d.id}')">Eliminar</button>
                        </td>
                    </tr>`;
            });
        });
    }

    // LISTAR PAGOS REPORTADOS
    onSnapshot(collection(db, "pagos_reportados"), (snap) => {
        const tbody = document.getElementById("listaPagos");
        tbody.innerHTML = "";
        snap.forEach(d => {
            const i = d.data();
            tbody.innerHTML += `
                <tr>
                    <td>${i.nombreEst}</td>
                    <td><small>${i.referencia}</small></td>
                    <td><b>$${i.monto}</b></td>
                    <td><button class="btn-notificar" style="background:var(--success); color:white" onclick="eliminarP('${d.id}')">Validar</button></td>
                </tr>`;
        });
    });

    window.notificar = (correo, alumno, mes, monto) => {
        if(!correo) return alert("Este alumno no tiene correo registrado");
        const body = `Estimado representante, le recordamos el pago pendiente de ${alumno} por el mes de ${mes} ($${monto}).`;
        window.location.href = `mailto:${correo}?subject=Recordatorio Pago SDJ&body=${encodeURIComponent(body)}`;
    };

    window.eliminarD = async (id) => { if(confirm("Â¿Eliminar registro?")) await deleteDoc(doc(db, "deudas", id)); };
    window.eliminarP = async (id) => { if(confirm("Â¿Confirmar validaciÃ³n?")) await deleteDoc(doc(db, "pagos_reportados", id)); };

    renderDeudores();
</script>
</body>
</html>
