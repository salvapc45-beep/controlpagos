<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA SDJ - CONTROL V16 (FULL)</title>
    <style>
        :root {
            --primary: #1e3a8a; --bg: #f8fafc; --text: #0f172a;
            --green: #22c55e; --yellow: #eab308; --red: #ef4444;
            --whatsapp: #25D366; --gmail: #DB4437;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }

        header { background: var(--primary); color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        /* NAV MEJORADO CON CALENDARIO */
        nav { display: flex; background: white; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid #e2e8f0; overflow-x: auto; }
        .nav-btn { flex: 1; min-width: 90px; padding: 15px 5px; text-align: center; cursor: pointer; font-weight: bold; font-size: 10px; color: #64748b; text-transform: uppercase; border-bottom: 4px solid transparent; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #f1f5f9; }

        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        .modulo { display: none; }
        .modulo.active { display: block; animation: fadeIn 0.4s; }

        /* CARDS & FORMS */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-top: 8px; font-size: 14px; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        
        /* ALERTAS & PENDIENTES */
        .btn-alert-all { background: #4f46e5; color: white; width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
        .btn-alert-all:active { transform: scale(0.98); }

        .grado-header { background: #1e293b; color: white; padding: 10px 15px; border-radius: 6px; font-weight: bold; text-transform: uppercase; font-size: 13px; margin: 25px 0 10px 0; letter-spacing: 0.5px; }

        .student-row { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 8px; position: relative; }
        .row-header { display: flex; justify-content: space-between; align-items: center; }
        
        /* BORDES DE ALERTA */
        .alert-previa { border-left: 6px solid var(--green); }
        .alert-normal { border-left: 6px solid var(--yellow); }
        .alert-urgente { border-left: 6px solid var(--red); }

        /* BADGES */
        .badge { font-size: 9px; padding: 3px 8px; border-radius: 4px; font-weight: bold; text-transform: uppercase; display: inline-block; margin-bottom: 4px; }
        .bg-previa { background: #dcfce7; color: #15803d; }
        .bg-normal { background: #fef9c3; color: #a16207; }
        .bg-urgente { background: #fee2e2; color: #b91c1c; }

        .info b { display: block; font-size: 15px; color: var(--primary); }
        .info small { color: #64748b; font-size: 12px; display: block; }
        .tag-mes { display: inline-block; background: #f1f5f9; border: 1px solid #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin: 4px 2px 0 0; color: #475569; }

        /* HISTORIAL VISIBLE EN FICHA */
        .historial-box { margin-top: 10px; background: #f8fafc; border: 1px dashed #cbd5e1; padding: 8px; border-radius: 6px; font-size: 11px; }
        .historial-item { padding: 4px 0; border-bottom: 1px solid #e2e8f0; color: #475569; }
        .tag-pagado { background: #dcfce7; color: #15803d; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 3px; display: inline-block; border: 1px solid #bbf7d0; }

        /* CALENDARIO ESTILOS */
        .event-card { background: white; border-left: 5px solid var(--primary); padding: 15px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .date-box { display: inline-block; background: #eff6ff; padding: 5px 10px; border-radius: 5px; font-weight: bold; color: var(--primary); margin-bottom: 5px; font-size: 12px; }

        /* ARCHIVOS */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 15px; }
        .folder { background: white; border: 1px solid #e2e8f0; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .folder:hover { background: #f8fafc; border-color: var(--primary); }
        .icon { font-size: 30px; display: block; margin-bottom: 5px; }

        /* TABLA REPORTES */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; font-size: 12px; }
        th { background: #f1f5f9; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .btn-check { background: var(--green); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-right: 5px; font-weight: bold; }
        .btn-reject { background: var(--red); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .btn-ws { border:none; background:transparent; font-size:22px; cursor:pointer; color: var(--whatsapp); margin-right: 5px; }
        .btn-mail { border:none; background:transparent; font-size:22px; cursor:pointer; color: var(--gmail); margin-right: 5px; }
        .btn-print { background: #64748b; color: white; border:none; padding: 8px 15px; border-radius: 5px; cursor: pointer; float: right; font-size: 12px;}

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        @media print {
            nav, header, .btn-print, button, input { display: none !important; }
            body, .container, .modulo { background: white; margin: 0; padding: 0; }
            .student-row { border: 1px solid #000; break-inside: avoid; }
            #mod-arch, #view-list, #final-list { display: block !important; }
        }
    </style>
</head>
<body>

<header>SISTEMA ADMINISTRATIVO SDJ (V16)</header>

<nav>
    <div class="nav-btn active" onclick="go('reg')">1. Registro</div>
    <div class="nav-btn" onclick="go('arch')">2. Archivos</div>
    <div class="nav-btn" onclick="go('pend')">3. Pendientes</div>
    <div class="nav-btn" onclick="go('solv')">4. Solventes</div>
    <div class="nav-btn" onclick="go('rep')">5. Reportes</div>
    <div class="nav-btn" onclick="go('cal')">6. Calendario</div>
</nav>

<div class="container">

    <section id="mod-reg" class="modulo active">
        <div class="card">
            <h3>Registrar Alumno / Deuda</h3>
            <p style="font-size:12px; color:gray; margin-bottom:10px">* Aseg√∫rese de usar punto (.) para los decimales.</p>
            
            <input type="text" id="rNom" placeholder="Nombre del Alumno">
            <input type="text" id="rRep" placeholder="Nombre del Representante">
            <input type="email" id="rMail" placeholder="Correo (Para Cobro Masivo)">
            <input type="tel" id="rTel" placeholder="Tel√©fono (Ej: 58412...)">
            
            <div style="display:flex; gap:10px">
                <select id="rGra">
                    <option>5to A√±o</option><option>4to A√±o</option><option>3er A√±o</option><option>2do A√±o</option><option>1er A√±o</option>
                    <option>6to Grado</option><option>5to Grado</option><option>4to Grado</option><option>3er Grado</option><option>2do Grado</option><option>1er Grado</option>
                    <option>Preescolar 3</option><option>Preescolar 2</option><option>Preescolar 1</option><option>Maternal</option>
                </select>
                <select id="rSec" style="width:100px"><option>A</option><option>B</option></select>
            </div>

            <label style="font-size:12px; font-weight:bold; margin-top:10px; display:block">Meses Pendientes:</label>
            <select id="rMes" multiple style="height:120px">
                <option value="Inscripci√≥n">Inscripci√≥n</option>
                <option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                <option value="Enero">Enero</option><option value="Febrero">Febrero</option><option value="Marzo">Marzo</option><option value="Abril">Abril</option>
                <option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option>
            </select>
            
            <input type="number" id="rMon" placeholder="Monto Mensual ($)" step="0.01">
            <button class="btn-main" onclick="guardar()">GUARDAR REGISTRO</button>
        </div>
    </section>

    <section id="mod-arch" class="modulo">
        <div id="view-level">
            <h3>Explorador de Archivos</h3>
            <div class="card" style="background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; margin-top:10px; text-align: center;">
                <small>DEUDA TOTAL DEL COLEGIO</small>
                <h2 id="global-debt" style="font-size: 28px;">Calculando...</h2>
            </div>

            <div class="folder-grid">
                <div class="folder" onclick="loadLevel('INICIAL')"><span class="icon">üìÇ</span>INICIAL</div>
                <div class="folder" onclick="loadLevel('PRIMARIA')"><span class="icon">üìÇ</span>PRIMARIA</div>
                <div class="folder" onclick="loadLevel('BACHILLERATO')"><span class="icon">üìÇ</span>BACHILLERATO</div>
            </div>
        </div>
        
        <div id="view-grade" style="display:none">
            <button onclick="resetArch()" style="margin-bottom:10px">‚¨Ö Atr√°s</button>
            <h3 id="tit-grade"></h3>
            <div id="grid-grade" class="folder-grid"></div>
        </div>
        
        <div id="view-sec" style="display:none">
            <button onclick="backToGrade()" style="margin-bottom:10px">‚¨Ö Atr√°s</button>
            <h3 id="tit-sec"></h3>
            <div class="folder-grid">
                <div class="folder" onclick="loadFinal('A')"><span class="icon">üìÅ</span>Secci√≥n A</div>
                <div class="folder" onclick="loadFinal('B')"><span class="icon">üìÅ</span>Secci√≥n B</div>
            </div>
        </div>
        
        <div id="view-list" style="display:none">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="backToSec()" style="margin-bottom:10px">‚¨Ö Atr√°s</button>
                <button class="btn-print" onclick="window.print()">üñ® Imprimir Lista</button>
            </div>
            
            <h3 id="tit-list"></h3>
            
            <div class="card" style="background:#fff7ed; border-color:#fed7aa; margin-top:10px; padding:15px;">
                <div style="text-align:right; margin-bottom:10px;">
                    <span id="sec-total-label" style="font-size:13px; color:#9a3412; font-weight:bold;">CALCULANDO DEUDA...</span>
                </div>
                <input type="text" id="search-filter" placeholder="üîç Buscar estudiante en esta secci√≥n..." onkeyup="filterList()" style="margin-top:0;">
            </div>

            <div class="card" style="margin-top:15px">
                <div id="final-list"></div>
            </div>
        </div>
    </section>

    <section id="mod-pend" class="modulo">
        <button class="btn-alert-all" onclick="notifyAll()">
            üì¢ COBRO MASIVO (Disparar Correos)
        </button>
        <div class="card">
            <div id="list-pend">Cargando deudores...</div>
        </div>
    </section>

    <section id="mod-solv" class="modulo">
        <div class="card"><h3>Estudiantes al D√≠a</h3><div id="list-solv"></div></div>
    </section>

    <section id="mod-rep" class="modulo">
        <div class="card">
            <h3>Pagos Reportados (Banco)</h3>
            <p style="font-size:12px; color:gray; margin-bottom:10px">‚ö†Ô∏è Al "Validar", el sistema descontar√° el mes m√°s antiguo de la deuda y lo guardar√° en el historial.</p>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Alumno / Rep</th><th>Ref / Banco</th><th>Monto</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="table-rep"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="mod-cal" class="modulo">
        <div class="card">
            <h3>Agregar Evento Escolar</h3>
            <input type="text" id="calTitle" placeholder="T√≠tulo del Evento (Ej: Entrega de Boletas)">
            <input type="date" id="calDate">
            <button class="btn-main" onclick="guardarEvento()">AGENDAR EVENTO</button>
        </div>
        <div class="card">
            <h3>Pr√≥ximos Eventos</h3>
            <div id="list-cal">Cargando calendario...</div>
        </div>
    </section>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, arrayUnion, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_m1k2Vlu5QTokgjNZ6czlI2XH1YTC3U8",
        authDomain: "reportedepagos-d8485.firebaseapp.com",
        projectId: "reportedepagos-d8485",
        storageBucket: "reportedepagos-d8485.appspot.com",
        messagingSenderId: "335664812002",
        appId: "1:335664812002:web:609ecb3008145281af3bb8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    const DB_MAIN = "sdj_final_v11"; 
    const DB_PAGOS = "pagos_reportados";
    const DB_CAL = "sdj_calendario"; // Nueva colecci√≥n para calendario

    const ORDEN_GRADOS = [
        "5to A√±o", "4to A√±o", "3er A√±o", "2do A√±o", "1er A√±o",
        "6to Grado", "5to Grado", "4to Grado", "3er Grado", "2do Grado", "1er Grado",
        "Preescolar 3", "Preescolar 2", "Preescolar 1", "Maternal"
    ];

    window.go = (id) => {
        document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mod-'+id).classList.add('active');
        event.currentTarget.classList.add('active');
    };

    // --- 1. REGISTRO Y CORRECCI√ìN DE DEUDA ($0) ---
    window.guardar = async () => {
        const ms = Array.from(document.getElementById('rMes').selectedOptions).map(o => o.value);
        const mon = parseFloat(document.getElementById('rMon').value);
        
        if (isNaN(mon) || mon <= 0) { alert("Error: Ingrese un Monto Mensual v√°lido (Num√©rico)."); return; }

        await addDoc(collection(db, DB_MAIN), {
            nombre: document.getElementById('rNom').value.trim(),
            rep: document.getElementById('rRep').value,
            mail: document.getElementById('rMail').value,
            tel: document.getElementById('rTel').value,
            grado: document.getElementById('rGra').value,
            seccion: document.getElementById('rSec').value,
            meses: ms,
            montoMensual: mon, // Guardamos precio unitario
            historial: [], 
            timestamp: new Date()
        });
        alert("¬°Registro Exitoso!"); location.reload();
    };

    let cachePendientes = [];

    // --- SNAPSHOT PRINCIPAL (Lectura de Alumnos) ---
    onSnapshot(collection(db, DB_MAIN), (snap) => {
        const lp = document.getElementById('list-pend');
        const ls = document.getElementById('list-solv');
        const globalDebt = document.getElementById('global-debt');
        
        lp.innerHTML = ""; ls.innerHTML = "";
        cachePendientes = [];
        let totalColegio = 0;

        let allData = [];
        snap.forEach(d => allData.push({ ...d.data(), id: d.id }));

        // PENDIENTES
        ORDEN_GRADOS.forEach(grado => {
            const grupo = allData.filter(x => x.grado === grado && x.meses && x.meses.length > 0);
            
            if(grupo.length > 0) {
                lp.innerHTML += `<div class="grado-header">${grado}</div>`;
                grupo.forEach(a => {
                    // C√ÅLCULO DIN√ÅMICO
                    const precio = parseFloat(a.montoMensual) || 0;
                    const deudaReal = a.meses.length * precio;
                    totalColegio += deudaReal;

                    const alerta = getNivelAlerta(a.meses.length);
                    cachePendientes.push({ ...a, deuda: deudaReal, tipoAlerta: alerta.tipo });

                    // BOTONES DE ACCI√ìN
                    let wsBtn = "", mailBtn = "";
                    if(a.tel) {
                        const msg = `Estimado(a) ${a.rep}, recordamos el pago pendiente de ${a.nombre}. Deuda Total: $${deudaReal.toFixed(2)}. Meses: ${a.meses.join(', ')}`;
                        wsBtn = `<button class="btn-ws" onclick="window.open('https://wa.me/${a.tel}?text=${encodeURIComponent(msg)}', '_blank')">üì±</button>`;
                    }
                    if(a.mail) {
                        mailBtn = `<button class="btn-mail" onclick="sendMail('${a.mail}', '${a.nombre}', '${alerta.tipo}', ${deudaReal})">‚úâÔ∏è</button>`;
                    }

                    lp.innerHTML += `
                        <div class="student-row alert-${alerta.clase}">
                            <div class="row-header">
                                <div class="info">
                                    <span class="badge bg-${alerta.clase}">${alerta.texto}</span>
                                    <b>${a.nombre} (${a.seccion})</b>
                                    <small>${a.rep}</small>
                                    <div>${a.meses.map(m => `<span class="tag-mes">${m}</span>`).join('')}</div>
                                </div>
                                <div style="text-align:right">
                                    <b style="color:#ef4444">$${deudaReal.toFixed(2)}</b><br>
                                    <div style="margin-top:5px; display:flex; justify-content:flex-end;">${wsBtn} ${mailBtn}</div>
                                    <button onclick="del('${a.id}')" style="font-size:10px; color:gray; border:none; background:none; cursor:pointer; margin-top:5px">Eliminar</button>
                                </div>
                            </div>
                        </div>`;
                });
            }
        });

        // SOLVENTES (Con desglose de meses pagados)
        allData.filter(x => !x.meses || x.meses.length === 0).forEach(a => {
            let mesesPagadosHTML = "";
            if (a.historial && a.historial.length > 0) {
                // Intentar extraer el mes del texto del historial
                mesesPagadosHTML = a.historial.map(h => {
                    const match = h.match(/Pag√≥ (.*?) -/);
                    return match ? `<span class="tag-pagado">${match[1]}</span>` : "";
                }).join('');
            }

            ls.innerHTML += `
                <div class="student-row" style="border-left:5px solid var(--green)">
                    <div class="row-header">
                        <div class="info"><b>${a.nombre}</b><small>${a.grado} (${a.seccion})</small></div>
                        <b style="color:var(--green)">SOLVENTE ‚úÖ</b>
                    </div>
                    <div style="margin-top:8px">
                        <small style="color:#64748b; display:block; margin-bottom:4px">Meses al d√≠a:</small>
                        ${mesesPagadosHTML || '<span class="tag-pagado">Sin historial reciente</span>'}
                    </div>
                </div>`;
        });

        if(globalDebt) globalDebt.innerText = `$${totalColegio.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    });

    function getNivelAlerta(meses) {
        const dia = new Date().getDate();
        if (meses >= 3 || (meses >= 1 && dia > 10)) {
            return { texto: "ALERTA URGENTE", clase: "urgente", tipo: "urgente" };
        } else if (meses === 2) {
            return { texto: "ALERTA NORMAL", clase: "normal", tipo: "normal" };
        } else {
            return { texto: "ALERTA PREVIA", clase: "previa", tipo: "previa" };
        }
    }

    // --- 2. LOGICA DE CORREOS (GMAIL Y MASIVO) ---
    window.sendMail = (mail, nom, tipo, monto) => {
        const asuntos = { previa: "Recordatorio", normal: "Aviso de Pago", urgente: "URGENTE: Deuda Vencida" };
        const cuerpos = {
            previa: `Estimado representante, recordamos el pago mensual de ${nom}. Monto: $${monto}.`,
            normal: `El alumno ${nom} presenta acumulaci√≥n de deuda ($${monto}). Favor regularizar.`,
            urgente: `AVISO IMPORTANTE: El alumno ${nom} tiene deuda vencida ($${monto}).`
        };
        window.location.href = `mailto:${mail}?subject=${asuntos[tipo]}&body=${cuerpos[tipo]}`;
    };

    window.notifyAll = () => {
        if(cachePendientes.length === 0) { alert("No hay deudores con correo."); return; }
        if(confirm(`Se abrir√°n ${cachePendientes.length} correos. ¬øContinuar?`)) {
            let delay = 0;
            cachePendientes.forEach((a) => {
                if(a.mail) {
                    setTimeout(() => {
                        window.open(`mailto:${a.mail}?subject=Aviso de Cobro SDJ&body=Deuda pendiente: $${a.deuda}`, '_blank');
                    }, delay);
                    delay += 1500;
                }
            });
        }
    };

    // --- 3. ARCHIVOS E HISTORIAL ---
    let curLvl = "", curGra = "";
    const struct = {
        'INICIAL': ['Maternal', 'Preescolar 1', 'Preescolar 2', 'Preescolar 3'],
        'PRIMARIA': ['1er Grado','2do Grado','3er Grado','4to Grado','5to Grado','6to Grado'],
        'BACHILLERATO': ['1er A√±o','2do A√±o','3er A√±o','4to A√±o','5to A√±o']
    };

    window.loadLevel = (l) => {
        curLvl = l;
        document.getElementById('view-level').style.display='none';
        document.getElementById('view-grade').style.display='block';
        document.getElementById('tit-grade').innerText = l;
        const grid = document.getElementById('grid-grade'); grid.innerHTML = "";
        struct[l].forEach(g => grid.innerHTML += `<div class="folder" onclick="loadSec('${g}')">üìÅ<br>${g}</div>`);
    };
    window.loadSec = (g) => { curGra = g; document.getElementById('view-grade').style.display='none'; document.getElementById('view-sec').style.display='block'; document.getElementById('tit-sec').innerText = g; };
    
    window.loadFinal = (s) => {
        document.getElementById('view-sec').style.display='none';
        document.getElementById('view-list').style.display='block';
        document.getElementById('tit-list').innerText = `${curGra} - SECCI√ìN ${s}`;
        document.getElementById('search-filter').value = "";
        
        onSnapshot(collection(db, DB_MAIN), (snap) => {
            const div = document.getElementById('final-list'); 
            const labelTotal = document.getElementById('sec-total-label');
            div.innerHTML = "";
            let deudaAcumulada = 0;

            snap.forEach(d => {
                const a = d.data();
                if(a.grado === curGra && a.seccion === s) {
                    const precio = parseFloat(a.montoMensual) || 0;
                    const deuda = (a.meses ? a.meses.length : 0) * precio;
                    if(deuda > 0) deudaAcumulada += deuda;
                    
                    const esSolvente = (deuda === 0);
                    
                    // MOSTRAR HISTORIAL
                    let historialHTML = "";
                    if(a.historial && a.historial.length > 0) {
                        historialHTML = `<div class="historial-box"><b>Historial:</b><br>${a.historial.map(h => `<div class="historial-item">${h}</div>`).join('')}</div>`;
                    }

                    div.innerHTML += `
                    <div class="student-row item-lista" data-name="${a.nombre.toLowerCase()}" style="border-left: 6px solid ${esSolvente ? 'var(--green)' : 'var(--red)'}; display:block">
                        <div class="row-header">
                            <div class="info"><b>${a.nombre}</b><small>${a.rep}</small></div>
                            <div style="text-align:right">
                                ${esSolvente ? '<b style="color:var(--green)">SOLVENTE</b>' : `<b style="color:var(--red)">DEUDA: $${deuda.toFixed(2)}</b>`}
                            </div>
                        </div>
                        ${historialHTML}
                    </div>`;
                }
            });
            labelTotal.innerHTML = deudaAcumulada > 0 ? `PENDIENTE SECCI√ìN: <span style="color:#ef4444">$${deudaAcumulada.toFixed(2)}</span>` : `<span style="color:var(--green)">SECCI√ìN AL D√çA</span>`;
        });
    };

    window.filterList = () => {
        const term = document.getElementById('search-filter').value.toLowerCase();
        document.querySelectorAll('.item-lista').forEach(item => {
            item.style.display = item.getAttribute('data-name').includes(term) ? "block" : "none";
        });
    };
    
    window.resetArch = () => { document.getElementById('view-grade').style.display='none'; document.getElementById('view-level').style.display='block'; };
    window.backToGrade = () => { document.getElementById('view-sec').style.display='none'; document.getElementById('view-grade').style.display='block'; };
    window.backToSec = () => { document.getElementById('view-list').style.display='none'; document.getElementById('view-sec').style.display='block'; };

    // --- 4. VALIDACI√ìN DE PAGOS ---
    onSnapshot(collection(db, DB_PAGOS), (snap) => {
        const tb = document.getElementById('table-rep'); tb.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            tb.innerHTML += `<tr>
                <td>${p.nombreEst}<br><small>${p.nombreRep || '-'}</small></td>
                <td><b>${p.banco || 'BANCO'}</b><br>${p.referencia || 'REF'}</td>
                <td>$${p.montoDivisas || p.monto || 0}</td>
                <td>
                    <button class="btn-check" onclick="validarPago('${d.id}', '${p.nombreEst}', '${p.banco}', '${p.referencia}', '${p.montoDivisas || p.monto}')">‚úî</button>
                    <button class="btn-reject" onclick="rechazar('${d.id}','${p.referencia}')">‚úñ</button>
                </td>
            </tr>`;
        });
    });

    window.validarPago = async(idPago, nombreEst, banco, ref, monto) => {
        if(!confirm(`¬øValidar pago de ${nombreEst}?`)) return;

        // Buscar alumno por nombre exacto
        const q = query(collection(db, DB_MAIN), where("nombre", "==", nombreEst));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) { alert("‚ùå Alumno no encontrado. Verifique nombre."); return; }

        let docRef = querySnapshot.docs[0];
        let data = docRef.data();
        let nuevosMeses = [...(data.meses || [])];
        
        let mesPagado = "Abono";
        if(nuevosMeses.length > 0) mesPagado = nuevosMeses.shift(); // Saca el primer mes

        let fechaHoy = new Date().toLocaleDateString();
        // Escribe en Historial
        await updateDoc(doc(db, DB_MAIN, docRef.id), {
            meses: nuevosMeses,
            historial: arrayUnion(`${fechaHoy}: Pag√≥ ${mesPagado} - $${monto} (Ref: ${ref} / ${banco})`)
        });

        // Borra de reportes
        await deleteDoc(doc(db, DB_PAGOS, idPago));
        alert("‚úÖ Pago procesado y guardado en historial.");
    };

    window.rechazar = async(id, ref) => {
        if(confirm("¬øRechazar pago?")) {
            window.location.href = `mailto:?subject=Error Pago SDJ&body=Referencia ${ref} no encontrada.`;
            await deleteDoc(doc(db, DB_PAGOS, id));
        }
    };
    
    window.del = async(id) => { if(confirm("¬øEliminar Alumno?")) await deleteDoc(doc(db, DB_MAIN, id)); };

    // --- 5. LOGICA DEL CALENDARIO (RESTAURADA) ---
    window.guardarEvento = async () => {
        const tit = document.getElementById('calTitle').value;
        const fec = document.getElementById('calDate').value;
        if(!tit || !fec) { alert("Complete t√≠tulo y fecha"); return; }

        await addDoc(collection(db, DB_CAL), {
            titulo: tit,
            fecha: fec,
            timestamp: new Date()
        });
        document.getElementById('calTitle').value = "";
    };

    onSnapshot(query(collection(db, DB_CAL), orderBy("fecha")), (snap) => {
        const div = document.getElementById('list-cal');
        div.innerHTML = "";
        snap.forEach(d => {
            const e = d.data();
            div.innerHTML += `
                <div class="event-card">
                    <span class="date-box">üìÖ ${e.fecha}</span>
                    <b>${e.titulo}</b>
                    <button onclick="delEvent('${d.id}')" style="float:right; border:none; color:red; cursor:pointer">üóë</button>
                </div>
            `;
        });
    });

    window.delEvent = async(id) => await deleteDoc(doc(db, DB_CAL, id));

</script>
</body>
</html>


