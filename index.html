<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA SDJ - GESTI√ìN V15</title>
    <style>
        :root {
            --primary: #1e3a8a; --bg: #f8fafc; --text: #0f172a;
            --green: #22c55e; --yellow: #eab308; --red: #ef4444;
            --whatsapp: #25D366; --modal-bg: rgba(0,0,0,0.6);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }

        header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        /* NAV */
        nav { display: flex; background: white; position: sticky; top: 0; z-index: 100; border-bottom: 2px solid #e2e8f0; overflow-x: auto; white-space: nowrap; }
        .nav-btn { flex: 1; padding: 15px 10px; text-align: center; cursor: pointer; font-weight: bold; font-size: 11px; color: #64748b; text-transform: uppercase; border-bottom: 4px solid transparent; }
        .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #f1f5f9; }

        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        .modulo { display: none; }
        .modulo.active { display: block; animation: fadeIn 0.3s; }

        /* CARDS & INPUTS */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #e2e8f0; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-top: 8px; font-size: 14px; background: #fff; }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        
        /* CALENDARIO */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
        .cal-day { background: white; border: 1px solid #e2e8f0; padding: 10px; text-align: center; border-radius: 5px; font-size: 12px; position: relative; }
        .cal-day.today { border: 2px solid var(--primary); font-weight: bold; background: #eff6ff; }
        .cal-day.pay-day { background: #fee2e2; color: var(--red); font-weight: bold; border-color: var(--red); }
        .alert-corte { background: var(--red); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; display: none; animation: pulse 2s infinite; }

        /* LISTAS */
        .student-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .student-row:hover { background: #f8fafc; border-color: var(--primary); }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; margin-right: 4px; display: inline-block; }
        
        /* MODAL (FICHA T√âCNICA) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 15px; padding: 25px; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #64748b; }
        .history-item { border-left: 3px solid var(--green); padding-left: 10px; margin-bottom: 10px; font-size: 12px; }

        /* TABLA REPORTES */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; font-size: 12px; }
        th { background: #f1f5f9; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
        .btn-action { padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; color: white; font-weight: bold; margin-right: 5px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<header>SISTEMA SDJ (V15)</header>

<nav>
    <div class="nav-btn active" onclick="go('reg')">1. Registro</div>
    <div class="nav-btn" onclick="go('arch')">2. Archivos</div>
    <div class="nav-btn" onclick="go('pend')">3. Pendientes</div>
    <div class="nav-btn" onclick="go('cal')">üìÖ Calendario</div>
    <div class="nav-btn" onclick="go('rep')">5. Reportes</div>
</nav>

<div class="container">

    <section id="mod-cal" class="modulo">
        <div class="card">
            <h3>Calendario de Cobranza</h3>
            <p style="font-size:12px; color:gray">El d√≠a 10 es la fecha l√≠mite. Si pasa, se activa la alerta masiva.</p>
            <div id="calendar-grid" class="cal-grid"></div>
        </div>
    </section>

    <section id="mod-reg" class="modulo active">
        <div class="card">
            <h3>Nuevo Estudiante</h3>
            <input type="text" id="rNom" placeholder="Nombre del Alumno">
            <input type="text" id="rRep" placeholder="Nombre del Representante">
            <input type="text" id="rCed" placeholder="C√©dula Representante (Para agrupar hermanos)">
            <input type="tel" id="rTel" placeholder="Tel√©fono (WhatsApp 58...)">
            <input type="email" id="rMail" placeholder="Correo">
            
            <div style="display:flex; gap:10px">
                <select id="rGra" onchange="checkSeccion()">
                    <option value="">Seleccione Grado...</option>
                    <option>5to A√±o</option><option>4to A√±o</option><option>3er A√±o</option><option>2do A√±o</option><option>1er A√±o</option>
                    <option>6to Grado</option><option>5to Grado</option><option>4to Grado</option><option>3er Grado</option><option>2do Grado</option><option>1er Grado</option>
                    <option>Preescolar 3</option><option>Preescolar 2</option><option>Preescolar 1</option><option>Maternal</option>
                </select>
                <select id="rSec" style="width:100px">
                    <option>U</option> </select>
            </div>

            <label style="font-size:12px; font-weight:bold; margin-top:10px; display:block">Seleccione Meses de Deuda Inicial:</label>
            <select id="rMes" multiple style="height:100px">
                <option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option>
                <option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                <option value="Enero">Enero</option><option value="Febrero">Febrero</option>
                <option value="Marzo">Marzo</option><option value="Abril">Abril</option>
                <option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option>
            </select>
            
            <input type="number" id="rMon" placeholder="Monto de la Mensualidad ($)">
            <button class="btn-main" onclick="guardar()">GUARDAR REGISTRO</button>
        </div>
    </section>

    <section id="mod-arch" class="modulo">
        <div class="card" style="background:#f0f9ff; border-color:#bae6fd">
            <input type="text" id="search-all" placeholder="üîç Buscar por Alumno o C√©dula Rep..." onkeyup="searchGlobal()">
            <div id="search-results" style="margin-top:10px"></div>
        </div>
        
        <div id="file-nav">
            <div id="view-level">
                <h3>Carpetas</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                    <button class="btn-main" style="margin:0" onclick="loadLevel('BACHILLERATO')">BACHILLERATO</button>
                    <button class="btn-main" style="margin:0" onclick="loadLevel('PRIMARIA')">PRIMARIA</button>
                    <button class="btn-main" style="margin:0" onclick="loadLevel('INICIAL')">INICIAL</button>
                </div>
            </div>
            <div id="view-grade" style="display:none"></div>
            <div id="view-sec" style="display:none"></div>
            <div id="view-list" style="display:none"></div>
        </div>
    </section>

    <section id="mod-pend" class="modulo">
        <div id="alert-10" class="alert-corte">
            <h2>‚ö†Ô∏è AVISO CR√çTICO</h2>
            <p>Ha pasado el d√≠a 10. Se habilit√≥ el cobro masivo.</p>
        </div>
        <div id="list-pend"></div>
    </section>

    <section id="mod-rep" class="modulo">
        <div class="card">
            <h3>Verificar Pagos</h3>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Datos</th><th>Pago</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="table-rep"></tbody>
                </table>
            </div>
        </div>
    </section>

</div>

<div id="modal-student" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 id="m-name">Nombre Alumno</h2>
        <p style="color:gray; margin-bottom:15px" id="m-grade">Grado - Secci√≥n</p>
        
        <label>Representante (Editable)</label>
        <input type="text" id="m-rep">
        <label>Tel√©fono (Editable)</label>
        <input type="tel" id="m-tel">
        <button onclick="updateStudent()" style="background:#3b82f6; color:white; border:none; padding:8px; border-radius:5px; margin-top:5px; width:100%">üíæ Guardar Cambios</button>

        <hr style="margin:15px 0">
        
        <h3>üí∞ Desglose de Deuda</h3>
        <ul id="m-debt-list" style="list-style:none; margin:10px 0;"></ul>
        <h4 style="text-align:right; color:var(--red)">Total: $<span id="m-total">0</span></h4>

        <hr style="margin:15px 0">

        <h3>üìú Historial de Pagos</h3>
        <div id="m-history-list" style="max-height:150px; overflow-y:auto; background:#f8fafc; padding:10px;"></div>
        
        <button onclick="deleteStudent()" style="background:#fee2e2; color:var(--red); border:none; padding:10px; width:100%; margin-top:15px; border-radius:5px">Eliminar del Sistema</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_m1k2Vlu5QTokgjNZ6czlI2XH1YTC3U8",
        authDomain: "reportedepagos-d8485.firebaseapp.com",
        projectId: "reportedepagos-d8485",
        storageBucket: "reportedepagos-d8485.appspot.com",
        messagingSenderId: "335664812002",
        appId: "1:335664812002:web:609ecb3008145281af3bb8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const DB_MAIN = "sdj_v15_students"; 
    const DB_PAGOS = "pagos_reportados";

    let currentStudentId = null; // Para el modal
    let allStudents = [];

    // --- NAVEGACI√ìN ---
    window.go = (id) => {
        document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mod-'+id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id === 'cal') renderCalendar();
        if(id === 'pend') checkDay10();
    };

    // --- L√ìGICA DE SECCIONES ---
    window.checkSeccion = () => {
        const g = document.getElementById('rGra').value;
        const s = document.getElementById('rSec');
        s.innerHTML = "";
        if(g.includes("A√±o")) { // Bachillerato
            s.innerHTML = "<option>A</option><option>B</option>";
        } else { // Primaria e Inicial
            s.innerHTML = "<option>U</option>"; // Secci√≥n √önica
        }
    };

    // --- GUARDAR ESTUDIANTE ---
    window.guardar = async () => {
        const ms = Array.from(document.getElementById('rMes').selectedOptions).map(o => o.value);
        const monto = parseFloat(document.getElementById('rMon').value) || 0;
        
        // Estructura de deuda detallada
        const deudaDetalle = ms.map(m => ({ mes: m, monto: monto }));

        await addDoc(collection(db, DB_MAIN), {
            nombre: document.getElementById('rNom').value,
            rep: document.getElementById('rRep').value,
            cedulaRep: document.getElementById('rCed').value, // Para agrupar hermanos
            tel: document.getElementById('rTel').value,
            mail: document.getElementById('rMail').value,
            grado: document.getElementById('rGra').value,
            seccion: document.getElementById('rSec').value,
            deuda: deudaDetalle, // Array de objetos {mes, monto}
            montoMensual: monto, // Para referencia futura
            historial: [],
            timestamp: new Date()
        });
        alert("Guardado Correctamente"); location.reload();
    };

    // --- ESCUCHA EN TIEMPO REAL ---
    onSnapshot(collection(db, DB_MAIN), (snap) => {
        allStudents = [];
        snap.forEach(d => allStudents.push({ ...d.data(), id: d.id }));
        renderPendientes();
    });

    // --- CALENDARIO ---
    window.renderCalendar = () => {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = "";
        const today = new Date().getDate();
        for(let i=1; i<=31; i++) {
            let cls = "cal-day";
            if(i === today) cls += " today";
            if(i === 10) cls += " pay-day";
            grid.innerHTML += `<div class="${cls}">${i}</div>`;
        }
    };

    window.checkDay10 = () => {
        const today = new Date().getDate();
        if(today > 10) document.getElementById('alert-10').style.display = 'block';
        else document.getElementById('alert-10').style.display = 'none';
    };

    // --- ARCHIVOS Y NAVEGACI√ìN ---
    const struct = {
        'INICIAL': ['Maternal', 'Preescolar 1', 'Preescolar 2', 'Preescolar 3'],
        'PRIMARIA': ['1er Grado','2do Grado','3er Grado','4to Grado','5to Grado','6to Grado'],
        'BACHILLERATO': ['1er A√±o','2do A√±o','3er A√±o','4to A√±o','5to A√±o']
    };
    let curLvl = "", curGra = "";

    window.loadLevel = (l) => {
        curLvl = l;
        document.getElementById('view-level').style.display='none';
        document.getElementById('view-grade').style.display='block';
        document.getElementById('view-grade').innerHTML = `<button onclick="resetArch()">‚¨Ö Atr√°s</button><h3>${l}</h3>` + 
            struct[l].map(g => `<div class="card" onclick="loadSec('${g}')">üìÅ ${g}</div>`).join('');
    };

    window.loadSec = (g) => {
        curGra = g;
        document.getElementById('view-grade').style.display='none';
        document.getElementById('view-sec').style.display='block';
        // L√≥gica A/B o √önica
        let html = `<button onclick="backToGrade()">‚¨Ö Atr√°s</button><h3>${g}</h3>`;
        if(g.includes("A√±o")) {
            html += `<div class="card" onclick="loadList('A')">üìÇ Secci√≥n A</div><div class="card" onclick="loadList('B')">üìÇ Secci√≥n B</div>`;
        } else {
            html += `<div class="card" onclick="loadList('U')">üìÇ Secci√≥n √önica</div>`;
        }
        document.getElementById('view-sec').innerHTML = html;
    };

    window.loadList = (s) => {
        document.getElementById('view-sec').style.display='none';
        document.getElementById('view-list').style.display='block';
        const list = allStudents.filter(x => x.grado === curGra && x.seccion === s);
        
        let html = `<button onclick="backToSec()">‚¨Ö Atr√°s</button><h3>${curGra} - ${s}</h3>`;
        list.forEach(std => {
            const total = std.deuda.reduce((sum, item) => sum + item.monto, 0);
            const color = total > 0 ? "border-left: 5px solid var(--red)" : "border-left: 5px solid var(--green)";
            html += `<div class="student-row" style="${color}" onclick="openModal('${std.id}')">
                <div><b>${std.nombre}</b><br><small>${std.rep}</small></div>
                <div style="text-align:right">
                    ${total > 0 ? `<span style="color:red">$${total}</span>` : `<span style="color:green">Solvente</span>`}
                </div>
            </div>`;
        });
        document.getElementById('view-list').innerHTML = html;
    };

    // --- BUSCADOR MULTIHIJOS ---
    window.searchGlobal = () => {
        const term = document.getElementById('search-all').value.toLowerCase();
        const res = document.getElementById('search-results');
        if(term.length < 3) { res.innerHTML=""; return; }
        
        const hits = allStudents.filter(s => 
            s.nombre.toLowerCase().includes(term) || 
            s.rep.toLowerCase().includes(term) || 
            (s.cedulaRep && s.cedulaRep.includes(term))
        );

        res.innerHTML = hits.map(s => `
            <div class="student-row" onclick="openModal('${s.id}')">
                <small>${s.grado}</small> <b>${s.nombre}</b>
            </div>
        `).join('');
    };

    // --- MODAL (FICHA T√âCNICA) ---
    window.openModal = (id) => {
        const s = allStudents.find(x => x.id === id);
        currentStudentId = id;
        document.getElementById('modal-student').style.display = 'flex';
        
        document.getElementById('m-name').innerText = s.nombre;
        document.getElementById('m-grade').innerText = `${s.grado} - Secci√≥n ${s.seccion}`;
        document.getElementById('m-rep').value = s.rep;
        document.getElementById('m-tel').value = s.tel;

        // Desglose Deuda
        const list = document.getElementById('m-debt-list');
        list.innerHTML = "";
        let total = 0;
        s.deuda.forEach(d => {
            total += d.monto;
            list.innerHTML += `<li>üìÖ ${d.mes}: <b>$${d.monto}</b></li>`;
        });
        document.getElementById('m-total').innerText = total;

        // Historial
        const hist = document.getElementById('m-history-list');
        hist.innerHTML = "";
        if(s.historial) {
            s.historial.forEach(h => {
                hist.innerHTML += `<div class="history-item">
                    <b>${h.fecha}</b> - Ref: ${h.ref}<br>
                    Pag√≥: $${h.montoRef} (${h.metodo})<br>
                    <small>Meses: ${h.mesesPagados}</small>
                </div>`;
            });
        }
    };

    window.closeModal = () => document.getElementById('modal-student').style.display = 'none';

    window.updateStudent = async () => {
        await updateDoc(doc(db, DB_MAIN, currentStudentId), {
            rep: document.getElementById('m-rep').value,
            tel: document.getElementById('m-tel').value
        });
        alert("Datos Actualizados"); closeModal();
    };

    window.deleteStudent = async () => {
        if(confirm("¬øSeguro de borrar este historial completo?")) {
            await deleteDoc(doc(db, DB_MAIN, currentStudentId));
            closeModal();
        }
    };

    // --- PENDIENTES & WHATSAPP ---
    function renderPendientes() {
        const div = document.getElementById('list-pend');
        div.innerHTML = "";
        
        // Filtramos solo los que deben
        const deudores = allStudents.filter(s => s.deuda.length > 0);
        
        deudores.forEach(s => {
            const mesesStr = s.deuda.map(d => d.mes).join(", ");
            const total = s.deuda.reduce((a,b)=>a+b.monto, 0);
            
            // MENSAJE WHATSAPP V15
            const msg = `Buenas tardes de parte del colegio Santiago de Jes√∫s se le informa que su representado ${s.nombre} debe ${mesesStr} para un total de $${total}. Agradecemos ponerse al d√≠a.`;
            const link = `https://wa.me/${s.tel}?text=${encodeURIComponent(msg)}`;

            div.innerHTML += `
            <div class="student-row" style="border-left:5px solid var(--red)">
                <div>
                    <b>${s.nombre}</b> (${s.grado})<br>
                    <small style="color:var(--red)">Debe: ${mesesStr}</small>
                </div>
                <div>
                    <b style="font-size:16px">$${total}</b>
                    <button onclick="window.open('${link}')" style="background:var(--whatsapp); color:white; border:none; padding:5px 10px; border-radius:5px; margin-left:5px">üì± Cobrar</button>
                </div>
            </div>`;
        });
    }

    // --- REPORTES Y PAGOS (VERIFICACI√ìN AVANZADA) ---
    onSnapshot(collection(db, DB_PAGOS), (snap) => {
        const tb = document.getElementById('table-rep'); tb.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            tb.innerHTML += `<tr>
                <td>${p.alumno}<br><small>${p.rep}</small></td>
                <td>
                    <b>Ref: ${p.referencia}</b><br>
                    ${p.metodo}<br>
                    Bs.${p.montoBs} / $${p.montoDivisa}<br>
                    <small>Meses: ${p.meses}</small>
                </td>
                <td>
                    <button class="btn-action" style="background:var(--green)" onclick="verificarPago('${d.id}', '${p.idAlumno}', '${p.meses}', '${p.referencia}', ${p.montoDivisa}, '${p.metodo}')">‚úî</button>
                    <button class="btn-action" style="background:var(--red)" onclick="rechazarPago('${d.id}')">‚úñ</button>
                </td>
            </tr>`;
        });
    });

    window.verificarPago = async (idPago, idAlumno, mesesStr, ref, monto, metodo) => {
        if(!confirm(`¬øValidar pago de $${monto}? Esto descontar√° la deuda.`)) return;

        // 1. Obtener al alumno
        const alumno = allStudents.find(x => x.id === idAlumno);
        if(!alumno) { alert("Alumno no encontrado"); return; }

        // 2. Calcular nueva deuda (Quitando meses pagados)
        // mesesStr viene como "Septiembre, Octubre"
        const mesesPagadosArr = mesesStr.split(',').map(s=>s.trim());
        const nuevaDeuda = alumno.deuda.filter(d => !mesesPagadosArr.includes(d.mes));

        // 3. Crear objeto historial
        const nuevoHistorial = {
            fecha: new Date().toLocaleDateString(),
            ref: ref,
            montoRef: monto,
            metodo: metodo,
            mesesPagados: mesesStr
        };

        // 4. Actualizar Firebase
        await updateDoc(doc(db, DB_MAIN, idAlumno), {
            deuda: nuevaDeuda,
            historial: arrayUnion(nuevoHistorial)
        });

        // 5. Borrar de pendientes
        await deleteDoc(doc(db, DB_PAGOS, idPago));
        alert("Pago procesado y deuda actualizada.");
    };

    window.rechazarPago = async (id) => {
        if(confirm("¬øRechazar y borrar?")) await deleteDoc(doc(db, DB_PAGOS, id));
    };

    // Funciones de navegaci√≥n auxiliares
    window.resetArch = () => { document.getElementById('view-grade').style.display='none'; document.getElementById('view-level').style.display='block'; };
    window.backToGrade = () => { document.getElementById('view-sec').style.display='none'; document.getElementById('view-grade').style.display='block'; };
    window.backToSec = () => { document.getElementById('view-list').style.display='none'; document.getElementById('view-sec').style.display='block'; };

</script>
</body>
</html>

