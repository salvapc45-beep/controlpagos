<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA SDJ - CONTROL BANCARIO</title>
    <style>
        :root {
            --primary: #1e3a8a; --accent: #3b82f6; --bg: #f1f5f9;
            --folder: #fcd34d; --success: #10b981; --danger: #ef4444; --text: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 60px; }

        header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; }
        
        /* NAVEGACI√ìN */
        nav { 
            display: flex; background: white; border-bottom: 2px solid #ddd; 
            position: sticky; top: 0; z-index: 100; overflow-x: auto;
        }
        .nav-btn { 
            flex: 1; min-width: 100px; padding: 15px 5px; text-align: center; 
            cursor: pointer; font-weight: bold; color: #64748b; font-size: 10px;
            border-bottom: 4px solid transparent; transition: 0.3s;
        }
        .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8fafc; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .modulo { display: none; }
        .modulo.active { display: block; animation: fadeIn 0.3s; }

        /* CARPETAS Y CARDS */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .folder { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; }
        .folder-icon { font-size: 35px; color: var(--folder); display: block; margin-bottom: 5px; }

        /* TABLA DE REPORTES PROFESIONAL */
        .report-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; font-size: 12px; }
        .report-table th { background: #f1f5f9; padding: 12px; text-align: left; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        .report-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        
        .bank-tag { background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 5px; font-weight: bold; font-size: 10px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 10px; border: 1px solid #eee; margin-bottom: 10px; }
        
        /* FORM */
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; }
        .btn-save { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>CONTROL ADMINISTRATIVO SDJ</header>

<nav>
    <div class="nav-btn active" onclick="tab('reg')">1. REGISTRO</div>
    <div class="nav-btn" onclick="tab('arch')">2. ARCHIVOS</div>
    <div class="nav-btn" onclick="tab('pend')">3. PENDIENTES</div>
    <div class="nav-btn" onclick="tab('solv')">4. SOLVENTES</div>
    <div class="nav-btn" onclick="tab('valid')">5. REPORTES</div>
</nav>

<div class="container">

    <section id="mod-reg" class="modulo active">
        <div class="card">
            <h3>Inscribir Estudiante</h3>
            <input type="text" id="rNom" placeholder="Nombre Estudiante">
            <input type="text" id="rRep" placeholder="Nombre Representante">
            <input type="email" id="rMail" placeholder="Correo de contacto">
            <select id="rGra">
                <option value="1er Grado">1er Grado</option><option value="2do Grado">2do Grado</option><option value="3er Grado">3er Grado</option>
                <option value="4to Grado">4to Grado</option><option value="5to Grado">5to Grado</option><option value="6to Grado">6to Grado</option>
                <option value="1er A√±o">1er A√±o</option><option value="2do A√±o">2do A√±o</option><option value="3er A√±o">3er A√±o</option>
                <option value="4to A√±o">4to A√±o</option><option value="5to A√±o">5to A√±o</option>
            </select>
            <select id="rSec"><option value="A">Secci√≥n A</option><option value="B">Secci√≥n B</option></select>
            <label style="font-size:11px; font-weight:bold; margin-top:10px; display:block">Marque meses que adeuda:</label>
            <select id="rMes" multiple style="height:100px">
                <option value="Inscripci√≥n">Inscripci√≥n</option><option value="Septiembre">Septiembre</option>
                <option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option>
                <option value="Diciembre">Diciembre</option><option value="Enero">Enero</option>
            </select>
            <input type="number" id="rMon" placeholder="Monto Mensual ($)">
            <button class="btn-save" onclick="guardarAlumno()">GUARDAR REGISTRO</button>
        </div>
    </section>

    <section id="mod-arch" class="modulo">
        <div id="v-niveles">
            <div class="folder-grid">
                <div class="folder" onclick="vGrados('PRIMARIA')"><span class="folder-icon">üìÇ</span>PRIMARIA</div>
                <div class="folder" onclick="vGrados('BACHILLERATO')"><span class="folder-icon">üìÇ</span>BACHILLERATO</div>
            </div>
        </div>
        <div id="v-grados" style="display:none">
            <button onclick="backN()">‚¨Ö Atr√°s</button>
            <div class="folder-grid" id="boxG" style="margin-top:15px"></div>
        </div>
        <div id="v-secciones" style="display:none">
            <button onclick="backG()">‚¨Ö Atr√°s</button>
            <div class="folder-grid" style="margin-top:15px">
                <div class="folder" onclick="vFinal('A')"><span class="folder-icon">üìÅ</span>Secci√≥n A</div>
                <div class="folder" onclick="vFinal('B')"><span class="folder-icon">üìÅ</span>Secci√≥n B</div>
            </div>
        </div>
        <div id="v-final" style="display:none">
            <button onclick="backS()">‚¨Ö Atr√°s</button>
            <div id="boxAlu" style="margin-top:15px"></div>
        </div>
    </section>

    <section id="mod-pend" class="modulo"><div class="card"><h3>Deudores</h3><div id="l-pend"></div></div></section>

    <section id="mod-solv" class="modulo"><div class="card"><h3>Solventes</h3><div id="l-solv"></div></div></section>

    <section id="mod-valid" class="modulo">
        <div class="card">
            <h3>Pagos por Verificar</h3>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Estudiante</th>
                        <th>Banco Destino</th>
                        <th>Referencia</th>
                        <th>Fecha</th>
                        <th>Monto (Bs/$)</th>
                        <th>Ok</th>
                    </tr>
                </thead>
                <tbody id="l-reportes"></tbody>
            </table>
        </div>
    </section>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_m1k2Vlu5QTokgjNZ6czlI2XH1YTC3U8",
        authDomain: "reportedepagos-d8485.firebaseapp.com",
        projectId: "reportedepagos-d8485",
        storageBucket: "reportedepagos-d8485.appspot.com",
        messagingSenderId: "335664812002",
        appId: "1:335664812002:web:609ecb3008145281af3bb8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let gCur = ""; 

    window.tab = (t) => {
        document.querySelectorAll('.modulo').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mod-'+t).classList.add('active');
        event.currentTarget.classList.add('active');
    };

    window.guardarAlumno = async () => {
        const ms = Array.from(document.getElementById('rMes').selectedOptions).map(o => o.value);
        await addDoc(collection(db, "sdj_db_v5"), {
            nombre: document.getElementById('rNom').value,
            representante: document.getElementById('rRep').value,
            correo: document.getElementById('rMail').value,
            grado: document.getElementById('rGra').value,
            seccion: document.getElementById('rSec').value,
            meses: ms,
            total: ms.length * (parseFloat(document.getElementById('rMon').value) || 0)
        });
        alert("Guardado");
        location.reload();
    };

    const niveles = {
        'PRIMARIA': ['1er Grado','2do Grado','3er Grado','4to Grado','5to Grado','6to Grado'],
        'BACHILLERATO': ['1er A√±o','2do A√±o','3er A√±o','4to A√±o','5to A√±o']
    };

    window.vGrados = (n) => {
        document.getElementById('v-niveles').style.display='none';
        document.getElementById('v-grados').style.display='block';
        const box = document.getElementById('boxG'); box.innerHTML = "";
        niveles[n].forEach(g => box.innerHTML += `<div class="folder" onclick="vSecs('${g}')"><span class="folder-icon">üìÅ</span>${g}</div>`);
    };

    window.vSecs = (g) => { gCur = g; document.getElementById('v-grados').style.display='none'; document.getElementById('v-secciones').style.display='block'; };

    window.vFinal = (s) => {
        document.getElementById('v-secciones').style.display='none';
        document.getElementById('v-final').style.display='block';
        onSnapshot(collection(db, "sdj_db_v5"), (snap) => {
            const box = document.getElementById('boxAlu'); box.innerHTML = "";
            snap.forEach(d => { if(d.data().grado === gCur && d.data().seccion === s) box.innerHTML += renderRow(d.data(), d.id); });
        });
    };

    onSnapshot(collection(db, "sdj_db_v5"), (snap) => {
        const lp = document.getElementById('l-pend'); const ls = document.getElementById('l-solv');
        lp.innerHTML = ""; ls.innerHTML = "";
        snap.forEach(d => {
            const a = d.data();
            if(a.meses.length > 0) lp.innerHTML += renderRow(a, d.id);
            else ls.innerHTML += renderRow(a, d.id);
        });
    });

    // REPORTE CON CAMPO BANCO
    onSnapshot(collection(db, "pagos_reportados"), (snap) => {
        const box = document.getElementById('l-reportes'); box.innerHTML = "";
        snap.forEach(d => {
            const r = d.data();
            box.innerHTML += `
                <tr>
                    <td><b>${r.nombreEst}</b><br><small>${r.nombreRep || 'S/N'}</small></td>
                    <td><span class="bank-tag">${r.banco || 'No indicado'}</span></td>
                    <td>${r.referencia}</td>
                    <td>${r.fecha || '-'}</td>
                    <td><b style="color:blue">Bs.${r.montoBs || '0'}</b><br><b style="color:green">$${r.montoDivisas || r.monto || '0'}</b></td>
                    <td><button onclick="borrarR('${d.id}')" style="background:var(--success); color:white; border:none; padding:5px; border-radius:5px; cursor:pointer">‚úÖ</button></td>
                </tr>`;
        });
    });

    function renderRow(a, id) {
        const pend = a.meses.length > 0;
        return `
            <div class="item-row" style="border-left: 5px solid ${pend ? 'var(--danger)' : 'var(--success)'}">
                <div><b>${a.nombre}</b><br><small>${a.grado} (${a.seccion})</small><br>${a.meses.join(', ')}</div>
                <div style="text-align:right">
                    ${pend ? `<b style="color:red">$${a.total}</b><br><button onclick="mail('${a.correo}','${a.nombre}','${a.meses.join(',')}','${a.total}')">‚úâÔ∏è</button>` : '<b style="color:green">AL D√çA</b>'}
                    <br><button onclick="delAlu('${id}')" style="color:red; border:none; background:none; font-size:10px; cursor:pointer">Borrar</button>
                </div>
            </div>`;
    }

    window.mail = (c,n,m,t) => window.location.href=`mailto:${c}?subject=Cobro&body=Alumno ${n} debe ${m}. Total: $${t}`;
    window.delAlu = async (id) => { if(confirm("¬øEliminar?")) await deleteDoc(doc(db, "sdj_db_v5", id)); };
    window.borrarR = async (id) => { if(confirm("¬øValidar pago?")) await deleteDoc(doc(db, "pagos_reportados", id)); };
    window.backN = () => { document.getElementById('v-grados').style.display='none'; document.getElementById('v-niveles').style.display='block'; };
    window.backG = () => { document.getElementById('v-secciones').style.display='none'; document.getElementById('v-grados').style.display='block'; };
    window.backS = () => { document.getElementById('v-final').style.display='none'; document.getElementById('v-secciones').style.display='block'; };
</script>
</body>
</html>
